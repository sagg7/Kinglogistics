(()=>{let e=[];const t=$("#subtotal"),a=$("#reductions"),n=$("#total");let o=Number(t.val()),s=Number(a.val()),r=Number(n.val());const i=e=>{const i=Number(e.amount);switch(e.type){case"remove":case"reduce":if(r-i<0)return throwErrorMsg("The total quantity must be bigger than $0"),!1;"reduce"===e.type?s+=i:o-=i,r-=i;break;case"increase":case"add":"increase"===e.type?s-=i:o+=i,r+=i}return t.val(d(o)),a.val(d(s)),n.val(d(r)),!0},d=e=>numeral(e).format("$0,0.00"),u=e=>e.value?numeral(e.value).format("$0,0.00"):"$0.00",l=e=>e.value?e.value.charAt(0).toUpperCase()+e.value.slice(1):"",p=()=>{if(_aggrid)return _aggrid.rowData=e,_aggrid.gridOptions.api.setRowData(e),_aggrid.grid.gridOptions.api.setPinnedBottomRowData(_aggrid.pinnedBottomFunction(_aggrid)),void _aggrid.gridOptions.api.sizeColumnsToFit();_aggrid=new simpleTableAG({id:"paymentData",columns:[{headerName:"Date",field:"date"},{headerName:"Type",field:"type",valueFormatter:l},{headerName:"Element Type",field:"objTypeName",valueFormatter:l},{headerName:"Description",field:"description"},{headerName:"Amount",field:"amount",valueFormatter:u},{headerName:"",field:"remove",cellRenderer:"RemoveBtnRenderer",width:70,maxWidth:70,minWidth:70,cellStyle:{padding:0}}],gridOptions:{components:{RemoveBtnRenderer,tableRef:"_aggrid"}},autoHeight:!0,rowData:e,removeValidation:e=>{switch(e.type){case"bonus":const t=bonuses.find((t=>t.id===e.id));if(r-t.amount<0)return throwErrorMsg("The total quantity must be bigger than $0"),!1}return!0},onRemoveRow:e=>{let t={},a=null;switch(e.type){case"expense":a=expenses.findIndex((t=>t.id===e.id)),t=expenses[a],isNaN(Number(e.id))&&expenses.splice(a,1),i({type:"increase",amount:t.amount});break;case"bonus":if(a=bonuses.findIndex((t=>t.id===e.id)),t=bonuses[a],!i({type:"remove",amount:t.amount}))return!1;isNaN(Number(e.id))&&bonuses.splice(a,1);break;default:return}t.delete=1}}),setTimeout((()=>{_aggrid.gridOptions.api.sizeColumnsToFit()}),300)};bonuses.forEach((t=>{e.push({id:t.id,type:"bonus",objType:t.bonust_type_id,objTypeName:t.bonus_type?t.bonus_type.name:"",amount:t.amount,date:t.date,description:t.description})})),expenses.forEach((t=>{e.push({id:t.id,type:"expense",objType:t.type_id,objTypeName:t.type?t.type.name:"",amount:t.amount,date:t.date?t.date:t.created_at,description:t.description})})),p(),t.val(d(t.val())),a.val(d(a.val())),n.val(d(n.val()));const m=$("#type"),c=$("#bonus-type-container"),b=$("#bonus_type"),g=$("#expense-type-container"),v=$("#expense_type"),y=$("[name=date_submit]"),h=$("#description"),f=$("#amount");m.select2({placeholder:"Select"}).on("select2:select",(function(e){switch(e.params.data.id){case"bonus":c.removeClass("d-none"),g.addClass("d-none"),v.val("").trigger("change");break;case"expense":c.addClass("d-none"),b.val(""),g.removeClass("d-none")}})),b.select2(),v.select2(),$("#addElement").click((()=>{const t=y.val(),a=h.val(),n=f.val();if(""===t||""===a||""===n)return throwErrorMsg("All fields must be filled to continue"),!1;const o=m.val();let s={id:`new_${Math.random().toString(36).substring(3,8)}`,amount:f.val(),date:y.val(),description:h.val()};switch(o){case"bonus":_.merge(s,{objType:b.val(),objTypeName:b.find("option:selected").text()}),bonuses.push(s),i({type:"add",amount:s.amount});break;case"expense":if(_.merge(s,{objType:v.val(),objTypeName:v.find("option:selected").text()}),!i({type:"reduce",amount:s.amount}))return!1;expenses.push(s)}e.push(_.merge(s,{type:o,date:moment(t).format("MM/DD/YYYY")})),p(),f.val(""),h.val("")})),$("#updatePayment").submit((e=>{e.preventDefault();const t=$(e.currentTarget).attr("action");$.ajax({url:t,type:"POST",data:{bonuses,expenses,subtotal:o,reductions:s,total:r},success:e=>{e.success?window.location="/carrier/payment":throwErrorMsg()},error:()=>{throwErrorMsg()}})}))})();

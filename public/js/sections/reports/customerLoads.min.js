(()=>{let e=null,a=[],t=[];const r=$("#dateRange"),i=$("#shipper"),o=$("#carrier"),d=$("#loads-data"),n=$("#carrier-data"),s=$("#driver-data");let l,c,p;const h=new simpleTableAG({id:"totalLoads",columns:[{headerName:"Finished at",field:"date"},{headerName: session['control_number'] ?? 'Control #',field:"control"},{headerName:session ? session['customer_reference'] : 'C Reference',field:"reference"},{headerName:"Bol",field:"bol"},{headerName:"Job",field:"job"}],rowData:[],gridOptions:{components:{tableRef:"modalLoadsTable"}},autoHeight:!0}),u=new simpleTableAG({id:"driverTable",columns:[{headerName:"Name",field:"driver"},{headerName:"Phone",field:"driver_phone"},{headerName:"Truck",field:"truck"},{headerName:"Carrier",field:"carrier",cellRenderer:f},{headerName:"Carrier Phone",field:"carrier_phone"}],rowData:[],gridOptions:{components:{tableRef:"modalDriverTable"}},autoHeight:!0});function m(){}function f(){}function v(){}m.prototype.init=e=>{const a=OptionsRenderer.prototype.guidGenerator();this.eGui=document.createElement("div"),e.value&&(this.eGui.innerHTML=`<a href="#" id="${a}">${e.value}</a>`,$((function(){$(`#${a}`).click((a=>{a.preventDefault(),$(".modal.show").modal("hide"),d.modal("show");const t=d.find(".content-body"),r=d.find(".modal-spinner");t.addClass("d-none"),r.removeClass("d-none"),p||(p=g("inactive","loads"));const i=D.rowData.filter((a=>a.carrier_id===e.data.carrier_id&&a.driver_id===e.data.driver_id&&a.shipper_id===e.data.shipper_id));p.rowData=i,p.gridOptions.api.setRowData(i),p.gridOptions.api.sizeColumnsToFit(),h.rowData=e.data.load_data,h.gridOptions.api.setRowData(e.data.load_data),h.gridOptions.api.sizeColumnsToFit(),t.removeClass("d-none"),r.addClass("d-none")}))})))},m.prototype.getGui=()=>this.eGui,f.prototype.init=e=>{const a=OptionsRenderer.prototype.guidGenerator();this.eGui=document.createElement("div"),e.value&&(this.eGui.innerHTML=`<a href="#" id="${a}">${e.value}</a>`,$((function(){$(`#${a}`).click((a=>{a.preventDefault(),$(".modal.show").modal("hide"),n.modal("show");const t=n.find(".content-body"),r=n.find(".modal-spinner"),i=n.find("#carrier-info tbody tr");t.addClass("d-none"),r.removeClass("d-none"),i.html(`<td>${e.data.carrier}</td><td>${e.data.carrier_phone?e.data.carrier_phone:""}</td>`),l||(l=g("active","carrier"),c=g("inactive","carrier"));const o=D.rowData.filter((a=>a.carrier_id===e.data.carrier_id)),d=w.rowData.filter((a=>a.carrier_id===e.data.carrier_id));l.rowData=o,l.gridOptions.api.setRowData(o),l.gridOptions.api.sizeColumnsToFit(),c.rowData=d,c.gridOptions.api.setRowData(d),c.gridOptions.api.sizeColumnsToFit(),t.removeClass("d-none"),r.addClass("d-none")}))})))},f.prototype.getGui=()=>this.eGui,v.prototype.init=e=>{const a=OptionsRenderer.prototype.guidGenerator();this.eGui=document.createElement("div"),e.value&&(this.eGui.innerHTML=`<a href="#" id="${a}">${e.value}</a>`,$((function(){$(`#${a}`).click((a=>{a.preventDefault(),$(".modal.show").modal("hide"),s.modal("show");const t=s.find(".content-body"),r=s.find(".modal-spinner");u.rowData=[e.data],u.gridOptions.api.setRowData([e.data]),u.gridOptions.api.sizeColumnsToFit(),t.removeClass("d-none"),r.addClass("d-none")}))})))},v.prototype.getGui=()=>this.eGui;const g=(e,a)=>{let t=[{headerName:"Truck",field:"truck"}];"active"===e&&t.push({headerName:"Total Loads",field:"loads",cellRenderer:m}),t.push({headerName:"Driver",field:"driver",cellRenderer:v}),"carrier"!==a&&t.push({headerName:"Carrier",field:"carrier",cellRenderer:f}),t.push({headerName:"Customer",field:"shipper"});const r=(i=a).charAt(0).toUpperCase()+i.slice(1);var i;return new simpleTableAG({id:`${e}${r}Drivers`,columns:t,rowData:[],gridOptions:{components:{tableRef:`${e}${r}DriversTable`}},autoHeight:!0})},D=g("active","general"),w=g("inactive","general"),C=(d=r.data().daterangepicker.startDate,n=r.data().daterangepicker.endDate)=>{$.ajax({url:"/report/customerLoadsData",type:"GET",data:{start:d.format("YYYY/MM/DD"),end:n.format("YYYY/MM/DD"),shipper:i.val(),carrier:o.val()},success:r=>{a=[],t=[];const i=[{name:"Total loads",data:[],type:"bar"},{name:"Active trucks",data:[],type:"line"}],o=[],d=[],n=e=>{const a=d.find((a=>a.id===e.shipper_id));if(a){if(a.loads+=e.loads,e.truck_id){-1===a.trucks.findIndex((a=>a===e.truck_id))&&a.trucks.push(e.truck_id)}}else d.push({id:e.shipper_id,name:e.shipper,loads:e.loads,trucks:[]}),e.truck_id&&d[d.length-1].trucks.push(e.truck_id)};r.active_data.forEach((e=>{n(e)})),r.inactive_data.forEach((e=>{e.shippers.forEach((a=>{n({shipper_id:a.id,shipper:a.name,loads:0}),t.push(_.merge(e,{shipper:a.name,shipper_id:a.id}))}))})),d.forEach((e=>{i[0].data.push(e.loads),i[1].data.push(e.trucks.length),o.push(e.name)})),((a,t)=>{const r={series:a,chart:{height:350,type:"line"},stroke:{width:[0,4]},title:{text:"Totals by Customer"},dataLabels:{enabled:!0,enabledOnSeries:[1]},labels:t,yaxis:[{title:{text:"Total Loads"}},{opposite:!0,title:{text:"Active trucks"}}]};e?e.updateOptions(r):(e=new ApexCharts(document.querySelector("#chart"),r),e.render())})(i,o),a=r.active_data,D.rowData=a,D.gridOptions.api.setRowData(a),D.gridOptions.api.sizeColumnsToFit(),w.rowData=t,w.gridOptions.api.setRowData(t),w.gridOptions.api.sizeColumnsToFit()},error:()=>{throwErrorMsg()}})};r.daterangepicker({format:"YYYY/MM/DD",startDate:moment().startOf("month"),endDate:moment().endOf("month")},((e,a,t)=>{C(e,a)})),i.select2({ajax:{url:"/shipper/selection",data:e=>({search:e.term,page:e.page||1,take:15})},placeholder:"Select",allowClear:!0}).on("select2:select",(()=>{C()})).on("select2:unselect",(()=>{C()})),o.select2({ajax:{url:"/carrier/selection",data:e=>({search:e.term,page:e.page||1,take:15})},placeholder:"Select",allowClear:!0}).on("select2:select",(()=>{C()})).on("select2:unselect",(()=>{C()})),C()})();

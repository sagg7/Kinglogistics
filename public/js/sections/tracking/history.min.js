(()=>{const o=o=>{let e={position:o.position,map:t,animation:google.maps.Animation.DROP,zIndex:100,icon:{url:"/images/app/tracking/icons/delivery-truck.svg",scaledSize:new google.maps.Size(40,40)}};const n=new google.maps.Marker(e);let a=[];if(Object.entries(o.poly.drivenPath).length>0){const e=o.poly.drivenPath.getPath().getArray();e.forEach(((n,r)=>{const s=o.poly.info[r];if(r+1<e.length){const o=n.lat(),e=n.lng(),i={position:{lat:o,lng:e},map:t,animation:google.maps.Animation.DROP};0===r&&(i.icon={url:"/images/app/tracking/icons/start-pin.svg",scaledSize:new google.maps.Size(40,40)});const l=new google.maps.Marker(i),p=`<strong>Date:</strong> ${moment(s.date).format("MM/DD/YYYY HH:mm")}<br><strong>Coords:</strong> ${o}, ${e}<br><strong>MPH:</strong> 0`,c=new google.maps.InfoWindow({content:p});l.infowindow=c,l.addListener("click",(()=>{c.open({anchor:l,map:t,shouldFocus:!0})})),a.push(l)}}))}p.push({driver:o.driver,carrier:o.carrier,load:{id:o.load},coords:`${o.position.lat}, ${o.position.lng}`,marker:n,poly:o.poly,polyMarkers:a});const r=p.length-1;return n.addListener("click",(()=>{const o=p[r];if(o.infowindow)o.infowindow.open({anchor:o.marker,map:t,shouldFocus:!0});else{const o=new google.maps.InfoWindow({content:'<div class="p-2"><div class="spinner-border text-secondary" role="status"></div></div>'});o.open({anchor:n,map:t,shouldFocus:!0}),((o,e)=>{const t=p[o];$.ajax({url:"/tracking/getPinLoadData",type:"GET",data:{load:t.load.id},success:o=>{const n=(o.shipper.name?`<p><strong>Shipper:</strong> ${o.shipper.name}</p>`:"")+`<p><strong>Status:</strong> ${a=o.status,"to_location"===a&&(a="in transit"),a.charAt(0).toUpperCase()+a.slice(1)}<br>`+(o.origin?`<strong>Origin:</strong> ${o.origin}<br><strong>Destination:</strong> ${o.destination}</p>`:"")+`<strong>Driver:</strong> ${t.driver.name}<br>`+(o.truck?`<strong>Truck#:</strong> ${o.truck.number}</p>`:"")+`<strong>Coords:</strong> ${t.coords}</p>`+`<strong>Date:</strong> ${moment(t.poly.info.date).format("MM/DD/YYYY HH:mm")}<br>`;var a;e.setContent(n),t.infowindow=e},error:()=>{throwErrorMsg()}})})(r,o)}})),n},e=()=>new google.maps.Map(document.getElementById("map"),{center:{lat:32.7096373,lng:-103.1525477},zoom:10,disableDefaultUI:!0,zoomControl:!0,fullscreenControl:!0});let t=e();const n=new google.maps.LatLngBounds;if(company){const o=(company.name?`<p><strong>Company:</strong> ${company.name}</p>`:"")+(company.contact_phone?`<p></p><strong>Phone:</strong> ${company.contact_phone}</p>`:"")+(company.email?`<p></p><strong>Email:</strong> ${company.email}</p>`:"")+(company.address?`<p></p><strong>Address:</strong> ${company.address}</p>`:""),e=new google.maps.InfoWindow({content:o}),a=company.location.split(","),r={position:{lat:Number(a[0]),lng:Number(a[1])},map:t,animation:google.maps.Animation.DROP,icon:{url:"/images/app/logos/logo-dark-simple.png",scaledSize:new google.maps.Size(30,30)}},s=new google.maps.Marker(r);s.addListener("click",(()=>{e.open({anchor:s,map:t,shouldFocus:!0})})),n.extend(s.position)}const a=$("#dateRange");a.daterangepicker({singleDatePicker:!0,format:"YYYY/MM/DD"},((o,e,t)=>{c(o,e)}));const r=$("[name=driver]"),s=$("[name=load]"),i=o=>{o.marker.setMap(null),o.poly.drivenPath&&Object.keys(o.poly.drivenPath).length>0&&o.poly.drivenPath.setMap(null),o.polyMarkers.length>0&&o.polyMarkers.forEach((o=>{o.setMap(null)}))},l=o=>{o.marker.setMap(t),o.poly.drivenPath&&Object.keys(o.poly.drivenPath).length>0&&o.poly.drivenPath.setMap(t),o.polyMarkers.length>0&&o.polyMarkers.forEach((o=>{o.setMap(t)}))};r.select2({placeholder:"Select",allowClear:!0}).on("select2:select",(o=>{const e=Number(o.params.data.id);p.forEach((o=>{o.driver.id!==e?i(o):l(o)}))})).on("select2:unselect",(()=>{p.forEach((o=>{l(o)}))})),s.select2({placeholder:"Select",allowClear:!0}).on("select2:select",(o=>{const e=Number(o.params.data.id);p.forEach((o=>{o.load.id!==e?i(o):l(o)}))})).on("select2:unselect",(()=>{p.forEach((o=>{l(o)}))}));let p=[];const c=(i=a.data().daterangepicker.startDate,l=a.data().daterangepicker.endDate)=>{p.length>0&&(t=e(),p=[]),$.ajax({url:"/tracking/historyData",type:"GET",data:{start:i.format("YYYY/MM/DD"),end:l.format("YYYY/MM/DD"),driver:$("[name='driver']").val()},success:e=>{(e=>{r.html("<option></option>").trigger("change"),s.html("<option></option>").trigger("change");let a=[],i=[];e.forEach((e=>{a.push({id:e.id,text:e.name});const r=e.locations,s=e.carrier,l=[];r.forEach(((o,t)=>{i.find((e=>e.id===o.parent_load.id))||i.push(o.parent_load);const a={lat:Number(o.latitude),lng:Number(o.longitude)},r=l.find((e=>e.id===o.load_id));r?(r.data.push(a),r.markersInfo.push({date:o.created_at})):l.push({id:o.load_id,data:[a],markersInfo:[{date:o.created_at}],driver:{id:e.id,name:e.name},carrier:{id:s.id,name:s.name}}),n.extend(a)})),l.forEach((e=>{const n=e.data;let a={};n.length>1&&(a=new google.maps.Polyline({path:n,geodesic:!0,strokeColor:`#${((Math.floor(127*Math.random()+127)<<16)+(Math.floor(127*Math.random()+127)<<8)+Math.floor(127*Math.random()+127)).toString(16)}`,strokeOpacity:1,strokeWeight:2,icons:[{icon:{path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW},repeat:"35px",offset:"100%"}]}),a.setMap(t));const r={position:n[n.length-1],driver:e.driver,carrier:e.carrier,load:e.id,poly:{drivenPath:a,info:e.markersInfo}};o(r)}))})),a.forEach((o=>{r.append(`<option value="${o.id}">${o.text}</option>`)})),r.trigger("change"),i.forEach((o=>{s.append(`<option value="${o.id}">${session['control_number'] ?? 'Control #'}${o.control_number}</option>`)})),s.trigger("change"),n.isEmpty()?t.setZoom(6):t.fitBounds(n)})(e)},error:()=>{throwErrorMsg()}})};c()})();

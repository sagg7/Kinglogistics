(()=>{const o=o=>{let n={position:o.position,map:e,animation:google.maps.Animation.DROP,zIndex:100,icon:{url:"/images/app/tracking/icons/delivery-truck.svg",scaledSize:new google.maps.Size(40,40)}};const t=new google.maps.Marker(n);let a=[];if(Object.entries(o.poly.drivenPath).length>0){const n=o.poly.drivenPath.getPath().getArray();n.forEach(((t,r)=>{const s=o.poly.info[r];if(r+1<n.length){const o=t.lat(),n=t.lng(),r={position:{lat:o,lng:n},map:e,animation:google.maps.Animation.DROP},i=new google.maps.Marker(r),p=`<strong>Date:</strong> ${moment(s.date).format("MM/DD/YYYY HH:mm:ss")}<br><strong>Coords:</strong> ${o}, ${n}<br><strong>MPH:</strong> 0`,l=new google.maps.InfoWindow({content:p});i.infowindow=l,i.addListener("click",(()=>{l.open({anchor:i,map:e,shouldFocus:!0})})),a.push(i)}}))}s.push({driver:o.driver,carrier:o.carrier,load:{id:o.load},coords:`${o.position.lat}, ${o.position.lng}`,marker:t,poly:o.poly,polyMarkers:a});const r=s.length-1;return t.addListener("click",(()=>{(o=>{const n=s[o];n.infowindow?n.infowindow.open({anchor:n.marker,map:e,shouldFocus:!0}):$.ajax({url:"/tracking/getPinLoadData",type:"GET",data:{load:n.load.id},success:o=>{const t=(o.shipper.name?`<p><strong>Shipper:</strong> ${o.shipper.name}</p>`:"")+`<p><strong>Status:</strong> ${a=o.status,"to_location"===a&&(a="in transit"),a.charAt(0).toUpperCase()+a.slice(1)}<br>`+(o.origin?`<strong>Origin:</strong> ${o.origin}<br><strong>Destination:</strong> ${o.destination}</p>`:"")+`<strong>Driver:</strong> ${n.driver.name}<br>`+`<strong>Truck#:</strong> ${o.truck.number}</p>`+`<strong>Coords:</strong> ${n.coords}</p>`;var a;const r=new google.maps.InfoWindow({content:t});n.infowindow=r,r.open({anchor:n.marker,map:e,shouldFocus:!0})},error:()=>{throwErrorMsg()}})})(r)})),t},e=new google.maps.Map(document.getElementById("map"),{center:{lat:39.8097343,lng:-98.5556199},zoom:10,disableDefaultUI:!0,zoomControl:!0,fullscreenControl:!0}),n=new google.maps.LatLngBounds;if(company){const o=(company.name?`<p><strong>Company:</strong> ${company.name}</p>`:"")+(company.contact_phone?`<p></p><strong>Phone:</strong> ${company.contact_phone}</p>`:"")+(company.email?`<p></p><strong>Email:</strong> ${company.email}</p>`:"")+(company.address?`<p></p><strong>Address:</strong> ${company.address}</p>`:""),t=new google.maps.InfoWindow({content:o}),a=company.location.split(","),r={position:{lat:Number(a[0]),lng:Number(a[1])},map:e,animation:google.maps.Animation.DROP,icon:{url:"/images/app/logos/logo-dark-simple.png",scaledSize:new google.maps.Size(30,30)}},s=new google.maps.Marker(r);s.addListener("click",(()=>{t.open({anchor:s,map:e,shouldFocus:!0})})),n.extend(s.position)}const t=$("#dateRange");t.daterangepicker({format:"YYYY/MM/DD",locale:dateRangeLocale,startDate:moment().startOf("month"),endDate:moment().endOf("month")},((o,e,n)=>{i(o,e)}));const a=$("[name=driver]");a.select2({placeholder:"Select",allowClear:!0}).on("select2:select",(o=>{const n=Number(o.params.data.id);s.forEach((o=>{o.driver.id!==n?(o.marker.setMap(null),o.poly.drivenPath&&o.poly.drivenPath.setMap(null)):(o.marker.setMap(e),o.poly.drivenPath&&o.poly.drivenPath.setMap(e))}))})).on("select2:unselect",(()=>{s.forEach((o=>{o.marker.setMap(e),o.poly.drivenPath&&o.poly.drivenPath.setMap(e)}))}));let r=[];const s=[],i=(i=t.data().daterangepicker.startDate,p=t.data().daterangepicker.endDate)=>{r=[],s.forEach((o=>{o.marker.setMap(null)})),s.length=0,$.ajax({url:"/tracking/historyData",type:"GET",data:{start:i.format("YYYY/MM/DD"),end:p.format("YYYY/MM/DD")},success:t=>{r=t,(()=>{a.html("<option></option>").trigger("change");let t=[];r.forEach((a=>{t.push({id:a.id,text:a.name});const r=a.locations,s=a.carrier,i=[];r.forEach(((o,e)=>{const t={lat:Number(o.latitude),lng:Number(o.longitude)},r=i.find((e=>e.id===o.load_id));r?(r.data.push(t),r.markersInfo.push({date:o.created_at})):i.push({id:o.load_id,data:[t],markersInfo:[{date:o.created_at}],driver:{id:a.id,name:a.name},carrier:{id:s.id,name:s.name}}),n.extend(t)})),i.forEach((n=>{const t=n.data;let a={};t.length>1&&(a=new google.maps.Polyline({path:t,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}),a.setMap(e));const r={position:t[t.length-1],driver:n.driver,carrier:n.carrier,load:n.id,poly:{drivenPath:a,info:n.markersInfo}};o(r)}))})),t.forEach((o=>{a.append(`<option value="${o.id}">${o.text}</option>`)})),a.trigger("change"),n.isEmpty()?e.setZoom(6):e.fitBounds(n)})()},error:()=>{throwErrorMsg()}})};i()})();

(()=>{const o=o=>{let t={position:o.position,map:e,animation:google.maps.Animation.DROP,zIndex:100,icon:{url:"/images/app/tracking/icons/delivery-truck.svg",scaledSize:new google.maps.Size(40,40)}};const n=new google.maps.Marker(t);let a=[];if(Object.entries(o.poly.drivenPath).length>0){const t=o.poly.drivenPath.getPath().getArray();t.forEach(((n,r)=>{const s=o.poly.info[r];if(r+1<t.length){const o=n.lat(),t=n.lng(),r={position:{lat:o,lng:t},map:e,animation:google.maps.Animation.DROP},i=new google.maps.Marker(r),p=`<strong>Date:</strong> ${moment(s.date).format("MM/DD/YYYY HH:mm")}<br><strong>Coords:</strong> ${o}, ${t}<br><strong>MPH:</strong> 0`,l=new google.maps.InfoWindow({content:p});i.infowindow=l,i.addListener("click",(()=>{l.open({anchor:i,map:e,shouldFocus:!0})})),a.push(i)}}))}s.push({driver:o.driver,carrier:o.carrier,load:{id:o.load},coords:`${o.position.lat}, ${o.position.lng}`,marker:n,poly:o.poly,polyMarkers:a});const r=s.length-1;return n.addListener("click",(()=>{const o=s[r];if(o.infowindow)o.infowindow.open({anchor:o.marker,map:e,shouldFocus:!0});else{const o=new google.maps.InfoWindow({content:'<div class="p-2"><div class="spinner-border text-secondary" role="status"></div></div>'});o.open({anchor:n,map:e,shouldFocus:!0}),((o,e)=>{const t=s[o];$.ajax({url:"/tracking/getPinLoadData",type:"GET",data:{load:t.load.id},success:o=>{const n=(o.shipper.name?`<p><strong>Shipper:</strong> ${o.shipper.name}</p>`:"")+`<p><strong>Status:</strong> ${a=o.status,"to_location"===a&&(a="in transit"),a.charAt(0).toUpperCase()+a.slice(1)}<br>`+(o.origin?`<strong>Origin:</strong> ${o.origin}<br><strong>Destination:</strong> ${o.destination}</p>`:"")+`<strong>Driver:</strong> ${t.driver.name}<br>`+`<strong>Truck#:</strong> ${o.truck.number}</p>`+`<strong>Coords:</strong> ${t.coords}</p>`+`<strong>Date:</strong> ${moment(t.poly.info.date).format("MM/DD/YYYY HH:mm")}<br>`;var a;e.setContent(n),t.infowindow=e},error:()=>{throwErrorMsg()}})})(r,o)}})),n},e=new google.maps.Map(document.getElementById("map"),{center:{lat:39.8097343,lng:-98.5556199},zoom:10,disableDefaultUI:!0,zoomControl:!0,fullscreenControl:!0}),t=new google.maps.LatLngBounds;if(company){const o=(company.name?`<p><strong>Company:</strong> ${company.name}</p>`:"")+(company.contact_phone?`<p></p><strong>Phone:</strong> ${company.contact_phone}</p>`:"")+(company.email?`<p></p><strong>Email:</strong> ${company.email}</p>`:"")+(company.address?`<p></p><strong>Address:</strong> ${company.address}</p>`:""),n=new google.maps.InfoWindow({content:o}),a=company.location.split(","),r={position:{lat:Number(a[0]),lng:Number(a[1])},map:e,animation:google.maps.Animation.DROP,icon:{url:"/images/app/logos/logo-dark-simple.png",scaledSize:new google.maps.Size(30,30)}},s=new google.maps.Marker(r);s.addListener("click",(()=>{n.open({anchor:s,map:e,shouldFocus:!0})})),t.extend(s.position)}const n=$("#dateRange");n.daterangepicker({format:"YYYY/MM/DD",startDate:moment().startOf("month"),endDate:moment().endOf("month")},((o,e,t)=>{i(o,e)}));const a=$("[name=driver]");a.select2({placeholder:"Select",allowClear:!0}).on("select2:select",(o=>{const t=Number(o.params.data.id);s.forEach((o=>{o.driver.id!==t?(o.marker.setMap(null),o.poly.drivenPath&&Object.keys(o.poly.drivenPath).length>0&&o.poly.drivenPath.setMap(null)):(o.marker.setMap(e),o.poly.drivenPath&&Object.keys(o.poly.drivenPath).length>0&&o.poly.drivenPath.setMap(e))}))})).on("select2:unselect",(()=>{s.forEach((o=>{o.marker.setMap(e),o.poly.drivenPath&&Object.keys(o.poly.drivenPath).length>0&&o.poly.drivenPath.setMap(e)}))}));let r=[];const s=[],i=(i=n.data().daterangepicker.startDate,p=n.data().daterangepicker.endDate)=>{r=[],s.forEach((o=>{o.marker.setMap(null)})),s.length=0,$.ajax({url:"/tracking/historyData",type:"GET",data:{start:i.format("YYYY/MM/DD"),end:p.format("YYYY/MM/DD")},success:n=>{r=n,(()=>{a.html("<option></option>").trigger("change");let n=[];r.forEach((a=>{n.push({id:a.id,text:a.name});const r=a.locations,s=a.carrier,i=[];r.forEach(((o,e)=>{const n={lat:Number(o.latitude),lng:Number(o.longitude)},r=i.find((e=>e.id===o.load_id));r?(r.data.push(n),r.markersInfo.push({date:o.created_at})):i.push({id:o.load_id,data:[n],markersInfo:[{date:o.created_at}],driver:{id:a.id,name:a.name},carrier:{id:s.id,name:s.name}}),t.extend(n)})),i.forEach((t=>{const n=t.data;let a={};n.length>1&&(a=new google.maps.Polyline({path:n,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2}),a.setMap(e));const r={position:n[n.length-1],driver:t.driver,carrier:t.carrier,load:t.id,poly:{drivenPath:a,info:t.markersInfo}};o(r)}))})),n.forEach((o=>{a.append(`<option value="${o.id}">${o.text}</option>`)})),a.trigger("change"),t.isEmpty()?e.setZoom(6):e.fitBounds(t)})()},error:()=>{throwErrorMsg()}})};i()})();

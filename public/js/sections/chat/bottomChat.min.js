(()=>{document.createElement("img").src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/timeline1.png";let e=!1;const s=$("#__chat_button"),a=$("#__chat_box"),t=$("#minimizeChat"),n=$("#__contacts"),i=$("#__chat_view"),o=$("#__chat_messages"),c=$("#__chats"),d=$("#__chat_message"),r=$("#__chat_button_counter"),l={chat:{container:o[0],scroll:new PerfectScrollbar(o[0],{wheelPropagation:!1})},contacts:{container:n,scroll:new PerfectScrollbar(n[0],{wheelPropagation:!1})}};let m={},_=[],g=null,p=null;const h=()=>{c.html("")},u=e=>{const s=moment().startOf("day"),a=moment().subtract(1,"days");let t="";return t=e.isSame(s,"d")?"Today":e.isSame(a,"d")?"Yesterday":e.format("M/D/YYYY"),t},f=(e,s=!1)=>{const a=e=>{const s=u(e);return`<div class="divider" data-date="${e.format("YYYY/MM/DD")}"><div class="divider-text">${s}</div></div>`},t=$(".chats .divider:first-child"),n=c.height(),i=o.scrollTop();e.forEach(((o,d)=>{const r=moment(o.created_at),m=moment(o.created_at).format("h:mm A");let _="";if(o.content&&(_=`${o.content}`),o.image&&(_=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${o.image_url}" alt="image"></a>${_}</div>`),s){if(t.length>0&&moment(t.data("date"),"YYYY/MM/DD").isSame(r,"date")&&t.remove(),p&&!p.isSame(r,"date")){const e=a(p);c.prepend(e)}p=r}else if(!g||!g.isSame(r,"date")){const e=a(r);c.append(e),g=r}const h=s?$(".chat:first-child"):$(".chat:last-child");if(0===h.length||h.hasClass("chat-left")&&!o.is_driver_sender||!h.hasClass("chat-left")&&o.is_driver_sender?(_=`<div class="message ${o.is_driver_sender?"left":"right"}"><div class="bubble">`+_+`<span>${m}</span></div></div>`,s?c.prepend(_):c.append(_)):s?h.find(".chat-body").prepend(_):h.find(".chat-body").append(_),s&&e.length===d+1){const e=a(r);c.prepend(e),l.chat.container.scrollTop=i+c.height()-n,c.find(".more-data-spinner").remove()}})),setTimeout((()=>{l.chat.scroll.update(),s||o[0].scrollTo(0,o[0].scrollHeight)}),350)};let v=!1;const b=e=>{const s=!m.messages||m.messages.more,a=m.messages?m.messages.page:1,t=m.messages?m.messages.history:[];(0===t.length||e)&&s?v||(v=!0,$.ajax({url:"/chat/getChatHistory",data:{driver_id:m.id,page:a,take:15},success:s=>{const n=[...s.results].reverse();m.messages={history:e?[...n,...t]:[...t,...n],more:s.pagination.more,page:a+1},f(e?s.results:n,e),s.pagination.more&&c.prepend('<div class="text-center more-data-spinner"><div class="spinner-border"></div></div>')}}).done((()=>{v=!1}))):e||(h(),f(m.messages.history))},y=()=>{$(".__contact").each((function(){const e=$(this);e.click((function(){e.find(".__message_count").remove();const s=e.data("userid"),a=m.id;m=_.find((e=>Number(e.id)===Number(s))),m.id!==a&&(h(),b());const t=e.offset(),n=e.parent().parent().offset();t.top,n.top;setTimeout((()=>{$("#__chat_profile p").addClass("animate"),$("#__chat_profile").addClass("animate")}),100),setTimeout((()=>{o.addClass("animate"),$(".cx, .cy").addClass("s1"),setTimeout((function(){$(".cx, .cy").addClass("s2")}),100),setTimeout((function(){$(".cx, .cy").addClass("s3")}),200)}),150),$(".floatingImg").animate({width:"68px",left:"108px",top:"20px"},200);const c=e.find("p strong").html();$("#__chat_profile p").html(c),$("#__contacts_list").fadeOut(),i.fadeIn(),$("#__close_chat").unbind("click").click((function(){$("#__chat_messages, #__chat_profile, #__chat_profile p").removeClass("animate"),$(".cx, .cy").removeClass("s1 s2 s3"),setTimeout((function(){i.fadeOut(),$("#__contacts_list").fadeIn()}),50)})),d.focus()}))}))};s.click((()=>{e=!0,s.addClass("hidden"),a.addClass("active"),r.addClass("d-none"),0===_.length&&$.ajax({url:"/chat/getContacts",type:"GET",success:e=>{_=e,_.forEach((e=>{const s=e.latest_message?u(moment(e.latest_message.created_at)):"",a=`<div class="__contact" data-userid="${e.id}"><div class="__message_content"><p><strong class="__contact_name">${e.name}</strong><span class="__message_preview truncate">${e.latest_message?e.latest_message.content?e.latest_message.content:'<i class="fas fa-camera"></i> Photo':""}</span></p><span class="__message_meta"><span class="__message_time d-block">${s}</span>`+(e.unread_count?`<span class="__message_count badge badge-primary badge-pill">${e.unread_count}</span>`:"")+"</span></div></div>";n.append(a)})),y()}})})),t.click((()=>{e=!1,s.removeClass("hidden"),a.removeClass("active")})),o[0].addEventListener("ps-scroll-up",(e=>{o[0].scrollTop<=25&&b(!0)}));let C=null;$("#__chat_send_message").submit((()=>{const e=d.val();let s="";if(""!==e&&(s=`${e}`,d.val(""),C=e),w.reader&&(s=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${w.reader.result}" alt="image"></a>${s}`),""===s)return!1;s+=`<span>${moment().format("h:mm A")}</span>`,(e=>{c.append('<div class="message right"><div class="bubble">'+e+"</div></div>")})(s),o[0].scrollTo(0,o[0].scrollHeight),((e=null,s=null)=>{const a=new FormData;e||s||(C&&(s=C),w.data&&(a.append("image",w.data),E()),e=[m.id]),a.append("message",s),e.forEach((e=>{a.append("drivers[]",e)})),$.ajax({url:"/chat/sendMessage",type:"POST",data:a,contentType:!1,processData:!1,success:e=>{e.success&&(C=null,m.messages.history.push(e.messages[0]))},error:()=>{throwErrorMsg()}}).always((()=>{}))})()}));let w={};const T=$("#__image_to_send"),x=T.find(".close-btn"),Y=T.find(".content-body"),E=()=>{T.removeClass("open"),w={},setTimeout((()=>{Y.html("")}),300)};$("#__chat_append").change((e=>{const s=$(e.currentTarget);if(""!==s.val()){const e=s.prop("files")[0],a=new FileReader;a.readAsDataURL(e),a.onload=()=>{Y.html(`<img class="img-fluid mx-auto" src="${a.result}" alt="image"></a>`),Y.removeClass("d-none"),T.addClass("open")},w={reader:a,data:e},s.val("")}})),x.click((()=>{E()})),window.addEventListener("keydown",(e=>{"Escape"===e.key&&T.hasClass("open")&&E()})),$("#__search_contact").on("keyup",(function(){var e=$(this).val().toLowerCase();""!==e?n.find(".__contact .__message_content p").filter((function(){$(this).closest(".__contact").toggle($(this).text().toLowerCase().indexOf(e)>-1)})):n.find(".__contact").show()})),$("#imagePreview").on("show.bs.modal",(e=>{const s=$(e.currentTarget),a=s.find(".modal-body").find(".modal-spinner"),t=s.find(".content-body"),n=$(e.relatedTarget),i=n.closest(".chat-content").data("message"),o=n.find("img");if(i){const e=m.messages.history.find((e=>Number(e.id)===Number(i)));$.ajax({url:"/s3storage/getTemporaryUrl",type:"GET",data:{url:e.image},success:e=>{t.html(`<img src="${e}" alt="image" class="img-fluid">`),a.addClass("d-none"),t.removeClass("d-none")},error:()=>{throwErrorMsg()}})}else t.html(`<img src="${o.attr("src")}" alt="image" class="img-fluid">`),a.addClass("d-none"),t.removeClass("d-none")})).on("hidden.bs.modal",(e=>{const s=$(e.currentTarget),a=s.find(".modal-body").find(".modal-spinner"),t=s.find(".content-body");t.html(""),a.removeClass("d-none"),t.addClass("d-none")}));window.Echo.private(`chat.${userId}`).listen("NewChatMessage",(s=>{if(e||r.removeClass("d-none"),_.length>0){const e=s.message;e.newly_received=!0,((e,s,a)=>{const t=()=>{const t=$(`.__contact[data-userid="${e}"]`),n=t.find(".__message_preview"),i=t.find(".__message_time");if(n.text(s.content.substring(0,100)),"received"===a){const e=t.find(".__message_meta"),a=e.find(".__message_count");a.length>0?a.text(Number(a.text())+1):e.append('<span class="__message_count badge badge-primary badge-pill">1</span>'),i.text(moment(s.created_at).format("h:mm A"))}};if(m.id===e)f([s]),t();else{const a=_.find((s=>Number(s.id)===Number(e)));a.messages&&a.messages.history.push(s),t()}})(Number(e.driver_id),e,"received")}}))})();

(()=>{document.createElement("img").src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/timeline1.png";const e=$("#__chat_button"),s=$("#__chat_box"),a=$("#minimizeChat"),t=$("#__contacts"),n=$("#__chat_view"),i=$("#__chat_messages"),o=$("#__chats"),c=$("#__chat_message"),d={chat:{container:i[0],scroll:new PerfectScrollbar(i[0],{wheelPropagation:!1})},contacts:{container:t,scroll:new PerfectScrollbar(t[0],{wheelPropagation:!1})}};let r={},l=[],m=null,_=null;const g=()=>{o.html("")},p=e=>{const s=moment().startOf("day"),a=moment().subtract(1,"days");let t="";return t=e.isSame(s,"d")?"Today":e.isSame(a,"d")?"Yesterday":e.format("M/D/YYYY"),t},h=(e,s=!1)=>{const a=e=>{const s=p(e);return`<div class="divider" data-date="${e.format("YYYY/MM/DD")}"><div class="divider-text">${s}</div></div>`},t=$(".chats .divider:first-child"),n=o.height(),c=i.scrollTop();e.forEach(((i,r)=>{const l=moment(i.created_at),g=moment(i.created_at).format("h:mm A");let p="";if(i.content&&(p=`${i.content}`),i.image&&(p=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${i.image_url}" alt="image"></a>${p}</div>`),s){if(t.length>0&&moment(t.data("date"),"YYYY/MM/DD").isSame(l,"date")&&t.remove(),_&&!_.isSame(l,"date")){const e=a(_);o.prepend(e)}_=l}else if(!m||!m.isSame(l,"date")){const e=a(l);o.append(e),m=l}const h=s?$(".chat:first-child"):$(".chat:last-child");if(0===h.length||h.hasClass("chat-left")&&!i.is_driver_sender||!h.hasClass("chat-left")&&i.is_driver_sender?(p=`<div class="message ${i.is_driver_sender?"left":"right"}"><div class="bubble">`+p+`<span>${g}</span></div></div>`,s?o.prepend(p):o.append(p)):s?h.find(".chat-body").prepend(p):h.find(".chat-body").append(p),s&&e.length===r+1){const e=a(l);o.prepend(e),d.chat.container.scrollTop=c+o.height()-n,o.find(".more-data-spinner").remove()}})),setTimeout((()=>{d.chat.scroll.update(),s||i[0].scrollTo(0,i[0].scrollHeight)}),350)};let u=!1;const f=e=>{const s=!r.messages||r.messages.more,a=r.messages?r.messages.page:1,t=r.messages?r.messages.history:[];(0===t.length||e)&&s?u||(u=!0,$.ajax({url:"/chat/getChatHistory",data:{driver_id:r.id,page:a,take:15},success:s=>{const n=[...s.results].reverse();r.messages={history:e?[...n,...t]:[...t,...n],more:s.pagination.more,page:a+1},h(e?s.results:n,e),s.pagination.more&&o.prepend('<div class="text-center more-data-spinner"><div class="spinner-border"></div></div>')}}).done((()=>{u=!1}))):e||(g(),h(r.messages.history))},v=()=>{$(".__contact").each((function(){const e=$(this);e.click((function(){e.find(".__message_count").remove();const s=e.data("userid"),a=r.id;r=l.find((e=>Number(e.id)===Number(s))),r.id!==a&&(g(),f());const t=e.offset(),o=e.parent().parent().offset();t.top,o.top;setTimeout((()=>{$("#__chat_profile p").addClass("animate"),$("#__chat_profile").addClass("animate")}),100),setTimeout((()=>{i.addClass("animate"),$(".cx, .cy").addClass("s1"),setTimeout((function(){$(".cx, .cy").addClass("s2")}),100),setTimeout((function(){$(".cx, .cy").addClass("s3")}),200)}),150),$(".floatingImg").animate({width:"68px",left:"108px",top:"20px"},200);const d=e.find("p strong").html();$("#__chat_profile p").html(d),$("#__contacts_list").fadeOut(),n.fadeIn(),$("#__close_chat").unbind("click").click((function(){$("#__chat_messages, #__chat_profile, #__chat_profile p").removeClass("animate"),$(".cx, .cy").removeClass("s1 s2 s3"),setTimeout((function(){n.fadeOut(),$("#__contacts_list").fadeIn()}),50)})),c.focus()}))}))};e.click((()=>{e.addClass("hidden"),s.addClass("active"),0===l.length&&$.ajax({url:"/chat/getContacts",type:"GET",success:e=>{l=e,l.forEach((e=>{const s=e.latest_message?p(moment(e.latest_message.created_at)):"",a=`<div class="__contact" data-userid="${e.id}"><div class="__message_content"><p><strong class="__contact_name">${e.name}</strong><span class="__message_preview truncate">${e.latest_message?e.latest_message.content?e.latest_message.content:'<i class="fas fa-camera"></i> Photo':""}</span></p><span class="__message_meta"><span class="__message_time d-block">${s}</span>`+(e.unread_count?`<span class="__message_count badge badge-primary badge-pill">${e.unread_count}</span>`:"")+"</span></div></div>";t.append(a)})),v()}})})),a.click((()=>{e.removeClass("hidden"),s.removeClass("active")})),i[0].addEventListener("ps-scroll-up",(e=>{i[0].scrollTop<=25&&f(!0)}));let b=null;$("#__chat_send_message").submit((()=>{const e=c.val();let s="";if(""!==e&&(s=`${e}`,c.val(""),b=e),y.reader&&(s=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${y.reader.result}" alt="image"></a>${s}`),""===s)return!1;s+=`<span>${moment().format("h:mm A")}</span>`,(e=>{o.append('<div class="message right"><div class="bubble">'+e+"</div></div>")})(s),i[0].scrollTo(0,i[0].scrollHeight),((e=null,s=null)=>{const a=new FormData;e||s||(b&&(s=b),y.data&&(a.append("image",y.data),x()),e=[r.id]),a.append("message",s),e.forEach((e=>{a.append("drivers[]",e)})),$.ajax({url:"/chat/sendMessage",type:"POST",data:a,contentType:!1,processData:!1,success:e=>{e.success&&(b=null,r.messages.history.push(e.messages[0]))},error:()=>{throwErrorMsg()}}).always((()=>{}))})()}));let y={};const w=$("#__image_to_send"),C=w.find(".close-btn"),T=w.find(".content-body"),x=()=>{w.removeClass("open"),y={},setTimeout((()=>{T.html("")}),300)};$("#__chat_append").change((e=>{const s=$(e.currentTarget);if(""!==s.val()){const e=s.prop("files")[0],a=new FileReader;a.readAsDataURL(e),a.onload=()=>{T.html(`<img class="img-fluid mx-auto" src="${a.result}" alt="image"></a>`),T.removeClass("d-none"),w.addClass("open")},y={reader:a,data:e},s.val("")}})),C.click((()=>{x()})),window.addEventListener("keydown",(e=>{"Escape"===e.key&&w.hasClass("open")&&x()})),$("#__search_contact").on("keyup",(function(){var e=$(this).val().toLowerCase();""!==e?t.find(".__contact .__message_content p").filter((function(){$(this).closest(".__contact").toggle($(this).text().toLowerCase().indexOf(e)>-1)})):t.find(".__contact").show()})),$("#imagePreview").on("show.bs.modal",(e=>{const s=$(e.currentTarget),a=s.find(".modal-body").find(".modal-spinner"),t=s.find(".content-body"),n=$(e.relatedTarget),i=n.closest(".chat-content").data("message"),o=n.find("img");if(i){const e=r.messages.history.find((e=>Number(e.id)===Number(i)));$.ajax({url:"/s3storage/getTemporaryUrl",type:"GET",data:{url:e.image},success:e=>{t.html(`<img src="${e}" alt="image" class="img-fluid">`),a.addClass("d-none"),t.removeClass("d-none")},error:()=>{throwErrorMsg()}})}else t.html(`<img src="${o.attr("src")}" alt="image" class="img-fluid">`),a.addClass("d-none"),t.removeClass("d-none")})).on("hidden.bs.modal",(e=>{const s=$(e.currentTarget),a=s.find(".modal-body").find(".modal-spinner"),t=s.find(".content-body");t.html(""),a.removeClass("d-none"),t.addClass("d-none")}));window.Echo.private("chat").listen("NewChatMessage",(e=>{const s=e.message;s.newly_received=!0,((e,s,a)=>{const t=()=>{const t=$(`.__contact[data-userid="${e}"]`),n=t.find(".__message_preview"),i=t.find(".__message_time");if(n.text(s.content.substring(0,100)),"received"===a){const e=t.find(".__message_meta"),a=e.find(".__message_count");a.length>0?a.text(Number(a.text())+1):e.append('<span class="__message_count badge badge-primary badge-pill">1</span>'),i.text(moment(s.created_at).format("h:mm A"))}};if(r.id===e)h([s]),t();else{const a=l.find((s=>Number(s.id)===Number(e)));a.messages&&a.messages.history.push(s),t()}})(Number(s.driver_id),s,"received")}))})();

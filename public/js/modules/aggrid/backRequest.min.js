function OptionsRenderer(){}OptionsRenderer.prototype.guidGenerator=()=>{let e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},OptionsRenderer.prototype.confirmationFunction=(e,t,i,n=null)=>{Swal.fire({title:i.title,showCancelButton:!0,confirmButtonText:"Confirm",cancelButtonText:"Cancel",confirmButtonColor:"#7367F0",cancelButtonColor:"#EA5455",allowOutsideClick:()=>!Swal.isLoading()}).then((s=>{s.value&&$.ajax({url:e,type:"POST",success:e=>{e.success?(i.stopReloadOnConfirm||window[t].updateSearchQuery(),i.afterConfirmFunction&&i.afterConfirmFunction(n)):throwErrorMsg(e.msg)},error:()=>{throwErrorMsg()}})}))},OptionsRenderer.prototype.deleteFunction=(e,t)=>{OptionsRenderer.prototype.confirmationFunction(e,t,{title:"Confirmation to delete item"})},OptionsRenderer.prototype.init=params=>{this.eGui=document.createElement("div");let popId=OptionsRenderer.prototype.guidGenerator(),menu=`<button class="btn waves-effect waves-light" data-toggle="popover" data-placement="top" data-container="body" id="pop-${popId}"><i class="fa fa-bars"></i></button>`,content='<ul class="list-group list-group-flush">',menuData={};params.data.menuId=[],params.colDef.menuData.forEach(((item,i)=>{const itemId=OptionsRenderer.prototype.guidGenerator();let href=`${item.route}/${params.data.id}`;if(item.route_params&&(href+="?",Object.entries(item.route_params).forEach((([e,t])=>{href+=`${e}=${t}&`}))),params.data.menuId.push({id:itemId,type:item.type}),item.type){let classId="",icon="",text="";if(item.conditional){let condition="params.data."+item.conditional;if(!eval(condition))return}switch(item.type){default:classId="",text=item.text,icon=item.icon;break;case"delete":classId="delete",text="Delete",icon="feather icon-trash-2";break;case"confirm":classId="confirm",text=item.text,icon=item.icon}menuData=item.menuData,content+=`<li class="list-group-item p-0"><a class="btn-link d-block p-1 ${classId}" href="${href}" id="${itemId}"><i class="${icon}"></i> ${text}</a></li>`}else item.modal?content+=`<li class="list-group-item p-0"><a class="btn-link d-block p-1 open-modal" href="${href}" id="${itemId}"><i class="${item.icon}"></i> ${item.text}</a></li>`:content+=`<li class="list-group-item p-0"><a class="btn-link d-block p-1" href="${href}" id="${itemId}"><i class="${item.icon}"></i> ${item.text}</a></li>`})),content+="</ul>",this.eGui.innerHTML=menu,$((function(){$(`#pop-${popId}`).popover({html:!0,content,trigger:"click"}).on("shown.bs.popover",(e=>{params.colDef.menuData.forEach(((e,t)=>{const i=params.data.menuId[t],n=$(`#${i.id}`);switch(console.log(e.type),e.type){default:break;case"modal":console.log("here"),n.click((e=>{console.log("open modal");let t=$(e.currentTarget).attr("href").split("/"),i=t[0],n=t[1];params.api.gridCore.gridOptions.components.OptionModalFunc(i,n)}));break;case"delete":n.click((function(e){e.preventDefault(),OptionsRenderer.prototype.deleteFunction(n.attr("href"),params.api.gridCore.gridOptions.components.tableRef)}));break;case"confirm":n.click((t=>{t.preventDefault(),OptionsRenderer.prototype.confirmationFunction(n.attr("href"),params.api.gridCore.gridOptions.components.tableRef,e.menuData,params)}))}})),$("body").on("click",(function(e){$("[id^=pop-]").each((function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$(this).popover("hide")}))}))}))}))},OptionsRenderer.prototype.getGui=()=>this.eGui;class DataSource{constructor(e){this.url=e.url,this.params=e.params,this.ajax=null,this.successCallback=e.successCallback,this.data=null}getRows(e){let t=e.request;if(this.params){let i=[];e.columnApi.columnController.columnDefs.forEach((e=>{!1!==e.filter&&i.push(e.field)})),t={...t,...this.params,searchable:i}}this.ajax=$.ajax({url:this.url,data:t,type:"GET",beforeSend:()=>{null!==this.ajax&&this.ajax.abort()},success:t=>{this.data=t,e.successCallback(t.rows,t.lastRow),this.successCallback&&this.successCallback(t)},error:()=>{e.failCallback()},always:()=>{this.ajax=null}})}}class tableAG{constructor(e){this.columns=e.columns,this.columnDefs=[],this.renderSimple=void 0!==e.renderSimple&&e.renderSimple,this.successCallback=void 0!==e.successCallback?e.successCallback:null,this.menu=e.menu?e.menu:[],this.constructColumns(),this.page=0,this.dataSource=null,this.searchQueryParams=e.searchQueryParams?e.searchQueryParams:{};let t=this.columnDefs;this.gridOptions={columnDefs:t,rowSelection:"multiple",pagination:!0,paginationPageSize:15,cacheBlockSize:30,rowModelType:"serverSide",pivotPanelShow:"always",colResizeDefault:"shift",animateRows:!0,components:{OptionsRenderer,OptionModalFunc:null,tableRef:e.tableRef},defaultColDef:{flex:1,minWidth:100,sortable:!0,resizable:!0,menuTabs:["filterMenuTab"]},onGridReady:function(t){setTimeout((()=>{t.columnApi.autoSizeAllColumns(),t.api.sizeColumnsToFit()}),300);let i,n=!1;function s(){new Date-i<550?setTimeout(s,550):(n=!1,t.columnApi.autoSizeAllColumns(),t.api.sizeColumnsToFit())}window.addEventListener("resize",(function(){i=new Date,!1===n&&(n=!0,setTimeout(s,550))})),e.autoHeight&&t.api.setDomLayout("autoHeight")}},"object"==typeof e.gridOptions&&null!==e.gridOptions&&_.merge(this.gridOptions,e.gridOptions),this.container=e.container,this.url=e.url,this.pinned=e.pinned,this.init()}constructColumns(){this.columns.forEach(((e,t)=>{let i=e;!1!==e.filter&&(i={filter:"agTextColumnFilter",filterParams:{resetButton:!0,debounceMs:1e3,suppressAndOrCondition:!0},...e}),this.columnDefs.push(i)})),!this.renderSimple&&this.menu.length>0&&this.columnDefs.push({headerName:"Menu",width:50,field:"options",filter:!1,sortable:!1,cellRenderer:"OptionsRenderer",menuData:this.menu})}constructHtml(){let e="<section>";return this.renderSimple||(e+=`<div class="row"><div class="col-12 p-0"><div class="ag-grid-btns d-flex justify-content-between flex-wrap mb-1"><div class="dropdown sort-dropdown mb-1 mb-sm-0"><button class="btn btn-white dropdown-toggle border text-dark filter-btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Show ${this.gridOptions.paginationPageSize}</button><div class="dropdown-menu dropdown-menu-right"><a class="dropdown-item" href="#">${this.gridOptions.paginationPageSize}</a><a class="dropdown-item" href="#">50</a><a class="dropdown-item" href="#">100</a><a class="dropdown-item" href="#">150</a></div></div><div class="ag-btns d-flex flex-wrap"><div class="input-group"><input type="text" class="ag-grid-filter form-control mb-1 mb-sm-0" placeholder="Search...." /><div class="input-group-append"><button class="btn btn-primary pl-1 pr-1 waves-effect waves-light" type="button"><i class="fa fa-search"></i></button></div></div></div></div></div>`),e+=`<div id="${this.container}" class="aggrid ag-theme-material w-100"</section>`,e}updateSearchQuery(e={}){let t={url:this.url,successCallback:this.successCallback};this.searchQueryParams?t.params=_.merge(e,this.searchQueryParams):t.params=e;let i=new DataSource(t);this.dataSource=i,this.gridOptions.api.setServerSideDatasource(i)}changePageSize(e){this.gridOptions.api.paginationSetPageSize(Number(e)),this.gridOptions.columnApi.autoSizeAllColumns(),this.gridOptions.api.sizeColumnsToFit()}init(){let e=document.querySelector(`#${this.container}`);e.id="",e.innerHTML=this.constructHtml();let t=document.querySelector(`#${this.container}`);const i=$(`#${this.container}`).closest("section");let n=i.find(".ag-grid-filter");n.on("keyup",(e=>{13===e.which&&this.updateSearchQuery({search:n.val()})})),n.parent().find("button").click((()=>{this.updateSearchQuery({search:n.val()})})),i.find(".sort-dropdown .dropdown-item").on("click",(e=>{let t=$(e.target);this.changePageSize(t.text()),i.find(".filter-btn").text("Mostrar "+t.text())})),$(".ag-grid-export-btn").on("click",(e=>{this.gridOptions.api.exportDataAsCsv()})),new agGrid.Grid(t,this.gridOptions),this.gridOptions.columnApi.autoSizeAllColumns(),this.gridOptions.api.sizeColumnsToFit(),$(window).width()<768?this.gridOptions.columnApi.setColumnPinned(this.pinned,null):this.gridOptions.columnApi.setColumnPinned(this.pinned,"left"),$(window).on("resize",(()=>{$(window).width()<768?this.gridOptions.columnApi.setColumnPinned(this.pinned,null):this.gridOptions.columnApi.setColumnPinned(this.pinned,"left")}));let s=new DataSource({url:this.url,successCallback:this.successCallback});this.dataSource=s,this.gridOptions.api.setServerSideDatasource(s)}}

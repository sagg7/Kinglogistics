document.addEventListener("DOMContentLoaded",function(){let e={allowClear:!0,ajax:{url:"/user/selection",data:e=>({role:3,search:e.term,page:e.page||1,take:15})}};$("#cal-event-title").select2(_.merge({allowClear:!0,ajax:{url:"/patient/selection",language:"es",data:e=>({search:e.term,page:e.page||1,take:15})}},select2Lang)).on("select2:select",function(e){$("#cal-event-cellphone").val(e.params.data.cellphone)});let t=$("#cal-event-user"),a=()=>{let e=t.val(),a=m.val();""!==e&&null!==e&&$.ajax({url:"/user/getTimeOff",type:"GET",data:{user_id:e,date:a,offDays:!h.offDays},success:e=>{h={date:a,hours:e.hours},e.offDays&&(h.offDays=e.offDays),g()}})};t.select2(_.merge(e,select2Lang)).on("select2:select",function(e){h={},c.val("").trigger("change"),m.val("").trigger("change"),a()}).on("select2:unselect",function(e){h={},g()}),$.ajax({url:"/appointment/statusSelection",type:"GET",success:e=>{e.success&&$("#cal-status").select2({data:e.data}).on("select2:select",function(e){let t=e.params.data;r=n[t.id]})}});let n={others:"#7367f0",attended:"#28c76f",not_attended:"#ea5455",on_hold:"#ff9f43"},l=$(".cal-category-bullets"),d=$(".cal-category-filters"),o=null,r=n.on_hold,s=document.getElementById("fc-default"),c=$("#cal-start-date"),i=initPickadateEs(c).pickadate("picker"),m=$("[name=start_submit]"),p=$("#cal-start-hour"),v=initPickatime(p,{interval:10}).pickatime("picker"),u=$("[name=hour_submit]"),f=null,h={},g=()=>{let e=e=>{e.click(e=>{e.preventDefault(),throwErrorMsg("La hora ya se encuentra asignada, favor de seleccionar otra hora")})},t=t=>{t.off("click").click(()=>{e(t)})};h.date!==m.val()?($.each(p.next().find(".picker__list-item"),(e,a)=>{let n=$(a);n.removeClass("text-danger").prop("disabled",!1),t(n)}),a()):$.each(p.next().find(".picker__list-item"),(a,n)=>{let l=$(n),d=moment(l.text(),"HH:mm A").format("HH:mm");h.hours.includes(d)?(l.addClass("text-danger").prop("disabled",!0),e(l)):(l.removeClass("text-danger").prop("disabled",!1),t(l))}),i.set("enable",!0);let n=[];h.offDays&&h.offDays.forEach(e=>{n.push(moment(e).toDate())}),n.length>0&&i.set("disable",n)};v.on({render:()=>{g()}}),c.change(()=>{g(),p.val("").trigger("change")});let x=e=>({id:e.event.id,patient:e.event.extendedProps.patient,cellphone:e.event.extendedProps.cellphone,title:e.event.title,start:e.event.start,end:e.event.end,description:e.event.extendedProps.description,color:e.event.color,user:e.event.extendedProps.user,status:e.event.extendedProps.status,allDay:e.event.allDay}),y=(e,t=null)=>{$.ajax({url:`/appointment/update/${e.id}`,type:"POST",data:{start:moment(e.start).format("YYYY-MM-DD HH:mm:ss"),end:e.end?moment(e.end).format("YYYY-MM-DD HH:mm:ss"):null,description:e.description,patient_id:e.patient,cellphone:e.cellphone,user_id:e.user.id,status:e.status},complete:()=>{t&&(t.find(".spinner-border").addClass("d-none"),t.find(".btn-text").removeClass("d-none").prop("disabled",!1))},success:t=>{t.success?(f&&(f.remove(),C.addEvent(e)),$(".modal-calendar").modal("hide")):throwErrorMsg()},error:e=>{let t='<ul class="text-left">';Object.values(e.responseJSON.errors).forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>",throwErrorMsg(t,{timer:!1})}})},C=new FullCalendar.Calendar(s,{plugins:["dayGrid","timeGrid","interaction"],locale:"es",customButtons:{addNew:{text:" Agregar",click:function(){let e=(new Date).toISOString().slice(0,10);$(".modal-calendar").modal("show"),$(".modal-calendar .cal-submit-event").addClass("d-none"),$(".modal-calendar .remove-event").addClass("d-none"),$(".modal-calendar .cal-add-event").removeClass("d-none"),$(".modal-calendar .cancel-event").removeClass("d-none"),$(".modal-calendar .add-category .chip").remove(),i.set("select",e)}}},header:{left:"addNew",center:"dayGridMonth,timeGridWeek,timeGridDay",right:"prev,title,next"},displayEventTime:!1,navLinks:!0,editable:!0,allDay:!0,navLinkDayClick:function(e){$(".modal-calendar").modal("show"),i.set("select",moment(e).format("YYYY-MM-DD"),{format:"yyyy-mm-dd"})},dateClick:function(e){$(".modal-calendar").modal("show"),i.set("select",e.dateStr,{format:"yyyy-mm-dd"}),v.set("select",moment(e.date).format("HH:m"),{format:"HH:i"})},eventClick:function(e){f=e.event,$(".modal-calendar").modal("show"),$(".modal-calendar #cal-event-title").html(`<option value="${e.event.extendedProps.patient}">${e.event.title}</option>`).val(e.event.extendedProps.patient).trigger("change"),$(".modal-calendar #cal-event-cellphone").val(e.event.extendedProps.cellphone),$(".modal-calendar #cal-event-user").html(`<option value="${e.event.extendedProps.user.id}">${e.event.extendedProps.user.name}</option>`).val(e.event.extendedProps.user.id).trigger("change"),$(".modal-calendar #cal-status").val(e.event.extendedProps.status).trigger("change"),i.set("select",moment(e.event.start).format("YYYY-MM-DD"),{format:"yyyy-mm-dd"}),v.set("select",moment(e.event.start).format("HH:m"),{format:"HH:i"}),$(".modal-calendar #cal-description").val(e.event.extendedProps.description),$(".modal-calendar .cal-submit-event").removeClass("d-none"),$(".modal-calendar .remove-event").removeClass("d-none"),$(".modal-calendar .cal-add-event").addClass("d-none"),$(".modal-calendar .cancel-event").addClass("d-none"),$(".calendar-dropdown .dropdown-menu").find(".selected").removeClass("selected")},events:(e,t,a)=>{$.ajax({url:"/appointment/getAppointments",data:{start:moment(e.start).format("YYYY-MM-DD"),end:moment(e.end).format("YYYY-MM-DD"),user:o},success:e=>{e.forEach((t,a)=>{e[a].allDay=!t.end&&"00:00:00"===t.start.split(" ")[1],e[a].color=n[t.status],e[a].user={id:t.user_id,name:t.user_name},e[a].status=t.status}),t(e)},error:e=>{a(e)}})},eventDrop:e=>{y(x(e))},eventResize:e=>{y(x(e))},views:{dayGrid:{eventLimit:5},timeGrid:{eventLimit:5},interaction:{eventLimit:5}}});C.render(),$("#basic-examples .fc-right").append(l.html()).append(d.html()),l.html(""),d.html("");let D=$("#filter-user");D.select2(_.merge(select2Lang,_.merge(e,{placeholder:"Filtrar doctor"}))).on("select2:select",function(e){let t=e.params.data;o=t.id,C.refetchEvents()}).on("select2:unselect",function(e){o=null,C.refetchEvents()}),D.next().addClass("ml-0"),$(".modal-calendar .cal-submit-event").on("click",function(){let e=$(this),t=$("#cal-event-title option:selected"),a=$("#cal-event-user option:selected"),l=$("#cal-status option:selected"),d=t.val(),o=$("#cal-event-cellphone").val(),s=t.text(),c=m.val(),i=u.val(),p=new Date(c+" "+i),v=$("#cal-description").val();e.find(".spinner-border").removeClass("d-none"),e.find(".btn-text").addClass("d-none").prop("disabled",!0),r=n[$("#cal-status").val()];let h={id:f.id,patient:d,cellphone:o,title:s,start:p,description:v,color:r,allDay:"00:00:00"===i,user:{id:a.val(),name:a.text()},status:l.val()};y(h,e)}),$(".remove-event").on("click",function(){Swal.fire({title:"ConfirmaciÃ³n para eliminar elemento",showCancelButton:!0,confirmButtonText:"Confirmar",cancelButtonText:"Cancelar",confirmButtonColor:"#7367F0",cancelButtonColor:"#EA5455",allowOutsideClick:()=>!Swal.isLoading()}).then(e=>{e.value&&$.ajax({url:`/appointment/delete/${f.id}`,type:"POST",success:e=>{e.success?(f.remove(),f=null,$(".modal-calendar").modal("hide")):throwErrorMsg()},error:()=>{throwErrorMsg()}})})}),$("td:not(.fc-event-container)").length>0&&$(".modal-calendar").on("hidden.bs.modal",function(e){h={},$(".modal-calendar .form-control").val("").trigger("change"),$(".modal-calendar #cal-status").prop("selectedIndex",0).trigger("change"),f=null}),$(".fc-day, .fc-time").click(e=>{$(".modal-calendar").modal("show"),$(".calendar-dropdown .dropdown-menu").find(".selected").removeClass("selected"),$(".modal-calendar .cal-submit-event").addClass("d-none"),$(".modal-calendar .remove-event").addClass("d-none"),$(".modal-calendar .cal-add-event").removeClass("d-none"),$(".modal-calendar .cancel-event").removeClass("d-none"),$(".modal-calendar .add-category .chip").remove(),r=n.on_hold}),$(".cal-add-event").on("click",function(){let e=$(this),t=$("#cal-event-title option:selected"),a=$("#cal-event-cellphone").val(),n=$("#cal-event-user option:selected"),l=$("#cal-status option:selected"),d=t.text(),o=t.val(),s=m.val(),c=u.val(),i=new Date(s+" "+c),p=$("#cal-description").val();e.find(".spinner-border").removeClass("d-none"),e.find(".btn-text").addClass("d-none").prop("disabled",!0),$.ajax({url:"/appointment/store",type:"POST",data:{start:moment(i).format("YYYY-MM-DD HH:mm:ss"),description:p,patient_id:o,cellphone:a,user_id:n.val(),status:l.val()},complete:()=>{e.find(".spinner-border").addClass("d-none"),e.find(".btn-text").removeClass("d-none").prop("disabled",!1)},success:e=>{if(e.success){$(".modal-calendar").modal("hide");let t={id:e.data.id,patient:o,cellphone:a,title:d,start:i,description:p,color:r,allDay:"00:00:00"===c,user:{id:n.val(),name:n.text()},status:l.val()};C.addEvent(t)}else throwErrorMsg()},error:e=>{let t='<ul class="text-left">';Object.values(e.responseJSON.errors).forEach(e=>{t+=`<li>${e}</li>`}),t+="</ul>",throwErrorMsg(t,{timer:!1})}})})});

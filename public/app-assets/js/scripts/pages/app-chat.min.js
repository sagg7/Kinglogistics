!function(a){"use strict";const e=a("#users-list"),s=a("#chats-list"),t=a("#contacts-list");contacts&&contacts.forEach((a=>{const e=a.latest_message?moment(a.latest_message.created_at).format("h:mm A"):"",i=`<li><div class="pr-1"><i></i></span></div><div class="user-chat-info" data-userid="${a.id}"><div class="contact-info"><h5 class="font-weight-bold mb-0">${a.name}</h5><p class="truncate">${a.latest_message?a.latest_message.content?a.latest_message.content:'<i class="fas fa-camera"></i> Photo':""}</p></div><div class="contact-meta"><span class="float-right mb-25">${e}</span>`+(a.unread_count?`<span class="badge badge-primary badge-pill float-right">${a.unread_count}</span>`:"")+"</div></div><i>";a.latest_message?s.append(i):t.append(i)}));const i={};if(a.app.menu.is_touch_device())a(".chat-user-list").css("overflow","scroll"),a(".profile-sidebar-area .scroll-area").css("overflow","scroll"),a(".user-chats").css("overflow","scroll"),a(".user-profile-sidebar-area").css("overflow","scroll");else{if(a(".chat-application .chat-user-list").length>0)new PerfectScrollbar(".chat-user-list");if(a(".chat-application .profile-sidebar-area .scroll-area").length>0)new PerfectScrollbar(".profile-sidebar-area .scroll-area");if(a(".chat-application .user-chats").length>0){const a=document.querySelector(".user-chats");i.chat={container:a,scroll:new PerfectScrollbar(a,{wheelPropagation:!1})},a.addEventListener("ps-scroll-up",(e=>{a.scrollTop<=25&&p(!0)}))}if(a(".chat-application .user-profile-sidebar-area").length>0)new PerfectScrollbar(".user-profile-sidebar-area")}a(".chat-application .sidebar-profile-toggle").on("click",(function(){a(".chat-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-profile-toggle").on("click",(function(){a(".user-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-status input:radio[name=userStatus]").on("change",(function(){var e="avatar-status-"+this.value;a(".header-profile-sidebar .avatar span").removeClass(),a(".sidebar-profile-toggle .avatar span").removeClass(),a(".header-profile-sidebar .avatar span").addClass(e+" avatar-status-lg"),a(".sidebar-profile-toggle .avatar span").addClass(e)})),a(".chat-application .close-icon").on("click",(function(){a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show"),a(".sidebar-content").hasClass("show")||a(".chat-overlay").removeClass("show")})),a(".chat-application .sidebar-close-icon").on("click",(function(){a(".sidebar-content").removeClass("show"),a(".chat-overlay").removeClass("show")})),a(".chat-application .chat-overlay").on("click",(function(){a(".app-content .sidebar-content").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show"),a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show")}));let o={};const r=a(".user-chats .chats"),c=()=>{r.html("")};let l=null,n=null;const d=(e,s=!1)=>{const t=moment().startOf("day"),o=moment().subtract(1,"days"),c=a=>{let e="";return e=a.isSame(t,"d")?"Today":a.isSame(o,"d")?"Yesterday":a.format("M/D/YYYY"),`<div class="divider" data-date="${a.format("YYYY/MM/DD")}"><div class="divider-text">${e}</div></div>`},d=a(".chats .divider:first-child"),h=a(i.chat.container).find(".chats"),p=h.height(),m=h.scrollTop();e.forEach(((t,o)=>{const g=moment(t.created_at);let u="";const v=`<span class="block text-right line-height-1"><sub>${moment(t.created_at).format("h:mm A")}</sub></span>`;u=t.content?`<p>${t.content}${v}</p>`:`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${t.image_url}" alt="image"></a>${v}</div>`,u=`<div class="chat-content" data-message="${t.id}">${u}</div>`;const f=a(s?".chat:first-child":".chat:last-child");if(s){if(d.length>0&&moment(d.data("date"),"YYYY/MM/DD").isSame(g,"date")&&d.remove(),n&&!n.isSame(g,"date")){const a=c(n);r.prepend(a)}n=g}else if(!l||!l.isSame(g,"date")){const a=c(g);r.append(a),l=g}if(0===f.length||f.hasClass("chat-left")&&!t.is_driver_sender||!f.hasClass("chat-left")&&t.is_driver_sender?(u=`<div class="chat ${t.is_driver_sender?"chat-left":""}"><div class="chat-body">`+u+"</div></div>",s?r.prepend(u):r.append(u)):s?f.find(".chat-body").prepend(u):f.find(".chat-body").append(u),s&&e.length===o+1){const a=c(g);r.prepend(a),i.chat.container.scrollTop=m+h.height()-p,r.find(".more-data-spinner").remove()}})),i.chat.scroll.update(),s||(i.chat.container.scrollTop=h.height())};let h=!1;const p=(e=!1)=>{const s=!o.messages||o.messages.more,t=o.messages?o.messages.page:1,i=o.messages?o.messages.history:[];a(".chat_header").find("h6").text(o.name),(0===i.length||e)&&s?h||(h=!0,a.ajax({url:"/chat/getChatHistory",data:{driver_id:o.id,page:t,take:15},success:a=>{const s=[...a.results].reverse();o.messages={history:e?[...s,...i]:[...i,...s],more:a.pagination.more,page:t+1},d(e?a.results:s,e),a.pagination.more&&r.prepend('<div class="text-center more-data-spinner"><div class="spinner-border"></div></div>')}}).done((()=>{h=!1}))):e||(c(),d(o.messages.history))};a(".chat-application .chat-user-list ul li").on("click",(function(){a(".chat-user-list ul li").hasClass("active")&&a(".chat-user-list ul li").removeClass("active"),a(this).addClass("active"),a(this).find(".badge").remove(),a(".chat-user-list ul li").hasClass("active")?(a(".start-chat-area").addClass("d-none"),a(".active-chat").removeClass("d-none")):(a(".start-chat-area").removeClass("d-none"),a(".active-chat").addClass("d-none"));const s=o.id;(()=>{const a=e.find("li.active").find(".user-chat-info").data("userid");o=contacts.find((e=>Number(e.id)===Number(a)))})(),o.id!==s&&(c(),p())}));var m=a(".user-chats");a(".chat-users-list-wrapper li").on("click",(function(){m.animate({scrollTop:m[0].scrollHeight},400)})),a(".chat-application .favorite i").on("click",(function(e){a(this).parent(".favorite").toggleClass("warning"),e.stopPropagation()})),a(".chat-application .menu-toggle").on("click",(function(e){a(".app-content .sidebar-left").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show")})),a(window).width()<992&&a(".chat-application .sidebar-toggle").on("click",(function(){a(".app-content .sidebar-content").addClass("show"),a(".chat-application .chat-overlay").addClass("show")})),a(window).width()>992&&a(".chat-application .chat-overlay").hasClass("show")&&a(".chat-application .chat-overlay").removeClass("show"),a(".chat-application #chat-search").on("keyup",(function(){var e=a(this).val().toLowerCase();""!=e?a(".chat-user-list .chat-users-list-wrapper li").filter((function(){a(this).toggle(a(this).text().toLowerCase().indexOf(e)>-1)})):a(".chat-user-list .chat-users-list-wrapper li").show()}));let g={};const u=e=>{e=`<div class="chat-content">${e}</div>`;const s=a(".chat:last-child");0===s.length||s.hasClass("chat-left")?(e=`<div class="chat"><div class="chat-body">${e}</div></div>`,a(".chats").append(e)):s.find(".chat-body").append(e)};a(".chat-app-input").submit((()=>{const e=a(".message"),s=e.val();if(""!==s){const t=`<p>${s}<span class="block text-right line-height-1"><sub>${moment().format("h:mm A")}</sub></span></p>`;u(t),e.val(""),a(".user-chats").scrollTop(a(".user-chats > .chats").height()),g={driver_id:o.id,string:s},a.ajax({url:"/chat/sendMessage",type:"POST",data:g,success:a=>{a.success&&(g={},o.messages.history.push(a.message))},error:()=>{throwErrorMsg()}})}})),a("#appendImage").change((e=>{const s=a(e.currentTarget);if(""!==s.val()){const e=s.prop("files")[0],t=new FileReader;t.readAsDataURL(e),t.onload=()=>{const a=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${t.result}" alt="image"></a><span class="block text-right line-height-1"><sub>${moment().format("h:mm A")}</sub></span></div>`;u(a)};const i=new FormData;i.append("image",e),i.append("driver_id",o.id),a.ajax({url:"/chat/sendMessage",type:"POST",data:i,contentType:!1,processData:!1,success:a=>{a.success&&o.messages.history.push(a.message)},error:()=>{throwErrorMsg()}}),s.val("")}})),a("#imagePreview").on("show.bs.modal",(e=>{const s=a(e.currentTarget),t=s.find(".modal-body").find(".modal-spinner"),i=s.find(".content-body"),r=a(e.relatedTarget),c=r.closest(".chat-content").data("message"),l=r.find("img");if(c){const e=o.messages.history.find((a=>Number(a.id)===Number(c)));a.ajax({url:"/s3storage/getTemporaryUrl",type:"GET",data:{url:e.image},success:a=>{i.html(`<img src="${a}" alt="image" class="img-fluid">`),t.addClass("d-none"),i.removeClass("d-none")},error:()=>{throwErrorMsg()}})}else i.html(`<img src="${l.attr("src")}" alt="image" class="img-fluid">`),t.addClass("d-none"),i.removeClass("d-none")})).on("hidden.bs.modal",(e=>{const s=a(e.currentTarget),t=s.find(".modal-body").find(".modal-spinner"),i=s.find(".content-body");i.html(""),t.removeClass("d-none"),i.addClass("d-none")})),window.Echo.private("chat").listen("NewChatMessage",(e=>{const s=e.message;if(s.newly_received=!0,o.id===s.driver_id)d([s]);else{const e=contacts.find((a=>Number(a.id)===Number(s.driver_id)));e.messages&&e.messages.history.push(s);const t=a(`.user-chat-info[data-userid="${s.driver_id}"]`),i=t.find(".truncate"),o=t.find(".contact-meta"),r=o.find(".badge");i.text(s.content.substring(0,100)),r.length>0?r.text(Number(r.text())+1):o.append('<span class="badge badge-primary badge-pill float-right">1</span>')}}))}(jQuery),$(window).on("resize",(function(){$(window).width()>992&&$(".chat-application .chat-overlay").hasClass("show")&&($(".app-content .sidebar-left").removeClass("show"),$(".chat-application .chat-overlay").removeClass("show")),$(window).width()<992&&($(".chat-application .chat-profile-sidebar").hasClass("show")&&$(".chat-profile-sidebar").removeClass("show"),$(".chat-application .sidebar-toggle").on("click",(function(){$(".app-content .sidebar-content").addClass("show"),$(".chat-application .chat-overlay").addClass("show")})))}));

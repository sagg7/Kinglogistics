!function(a){"use strict";const s=a("#users-list"),e=a("#chats-list"),t=a("#contacts-list");contacts&&contacts.forEach((a=>{const s=`<li><div class="pr-1"><i></i></span></div><div class="user-chat-info" data-userid="${a.id}"><div class="contact-info"><h5 class="font-weight-bold mb-0">${a.name}</h5><p class="truncate">${a.latest_message?a.latest_message.content:""}</p></div><div class="contact-meta"><span class="float-right mb-25">${a.latest_message?moment(a.latest_message.created_at).format("h:mm A"):""}</span></div></div><i>`;a.latest_message?e.append(s):t.append(s)}));const i={};if(a.app.menu.is_touch_device())a(".chat-user-list").css("overflow","scroll"),a(".profile-sidebar-area .scroll-area").css("overflow","scroll"),a(".user-chats").css("overflow","scroll"),a(".user-profile-sidebar-area").css("overflow","scroll");else{if(a(".chat-application .chat-user-list").length>0)new PerfectScrollbar(".chat-user-list");if(a(".chat-application .profile-sidebar-area .scroll-area").length>0)new PerfectScrollbar(".profile-sidebar-area .scroll-area");if(a(".chat-application .user-chats").length>0){const a=document.querySelector(".user-chats");i.chat={container:a,scroll:new PerfectScrollbar(a,{wheelPropagation:!1})},a.addEventListener("ps-scroll-up",(s=>{a.scrollTop<=25&&p(!0)}))}if(a(".chat-application .user-profile-sidebar-area").length>0)new PerfectScrollbar(".user-profile-sidebar-area")}a(".chat-application .sidebar-profile-toggle").on("click",(function(){a(".chat-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-profile-toggle").on("click",(function(){a(".user-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-status input:radio[name=userStatus]").on("change",(function(){var s="avatar-status-"+this.value;a(".header-profile-sidebar .avatar span").removeClass(),a(".sidebar-profile-toggle .avatar span").removeClass(),a(".header-profile-sidebar .avatar span").addClass(s+" avatar-status-lg"),a(".sidebar-profile-toggle .avatar span").addClass(s)})),a(".chat-application .close-icon").on("click",(function(){a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show"),a(".sidebar-content").hasClass("show")||a(".chat-overlay").removeClass("show")})),a(".chat-application .sidebar-close-icon").on("click",(function(){a(".sidebar-content").removeClass("show"),a(".chat-overlay").removeClass("show")})),a(".chat-application .chat-overlay").on("click",(function(){a(".app-content .sidebar-content").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show"),a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show")}));let o={};const c=a(".user-chats .chats"),r=()=>{c.html("")};let l=null,n=null;const h=(s,e=!1)=>{const t=moment().startOf("day"),o=moment().subtract(1,"days"),r=a=>{let s="";return s=a.isSame(t,"d")?"Today":a.isSame(o,"d")?"Yesterday":a.format("M/D/YYYY"),`<div class="divider" data-date="${a.format("YYYY/MM/DD")}"><div class="divider-text">${s}</div></div>`},h=a(".chats .divider:first-child"),d=a(i.chat.container).find(".chats"),p=d.height(),v=d.scrollTop();s.forEach(((t,o)=>{const m=moment(t.created_at);let u=`<div class="chat-content"><p>${t.content}<span class="block text-right line-height-1"><sub>${moment(t.created_at).format("h:mm A")}</sub></span></p></div>`;const f=a(e?".chat:first-child":".chat:last-child");if(e){if(h.length>0&&moment(h.data("date"),"YYYY/MM/DD").isSame(m,"date")&&h.remove(),n&&!n.isSame(m,"date")){const a=r(n);c.prepend(a)}n=m}else if(!l||!l.isSame(m,"date")){const a=r(m);c.append(a),l=m}if(0===f.length||f.hasClass("chat-left")&&!t.is_driver_sender||!f.hasClass("chat-left")&&t.is_driver_sender?(u=`<div class="chat ${t.is_driver_sender?"chat-left":""}"><div class="chat-body">`+u+"</div></div>",e?c.prepend(u):c.append(u)):e?f.find(".chat-body").prepend(u):f.find(".chat-body").append(u),e&&s.length===o+1){const a=r(m);c.prepend(a),i.chat.container.scrollTop=v+d.height()-p,c.find(".more-data-spinner").remove()}})),i.chat.scroll.update(),e||(i.chat.container.scrollTop=d.height())};let d=!1;const p=(s=!1)=>{const e=!o.messages||o.messages.more,t=o.messages?o.messages.page:1,i=o.messages?o.messages.history:[];a(".chat_header").find("h6").text(o.name),(0===i.length||s)&&e?d||(d=!0,a.ajax({url:"/chat/getChatHistory",data:{driver_id:o.id,page:t,take:15},success:a=>{const e=[...a.results].reverse();o.messages={history:s?[...e,...i]:[...i,...e],more:a.pagination.more,page:t+1},h(s?a.results:e,s),a.pagination.more&&c.prepend('<div class="text-center more-data-spinner"><div class="spinner-border"></div></div>')}}).done((()=>{d=!1}))):s||(r(),h(o.messages.history))};a(".chat-application .chat-user-list ul li").on("click",(function(){a(".chat-user-list ul li").hasClass("active")&&a(".chat-user-list ul li").removeClass("active"),a(this).addClass("active"),a(this).find(".badge").remove(),a(".chat-user-list ul li").hasClass("active")?(a(".start-chat-area").addClass("d-none"),a(".active-chat").removeClass("d-none")):(a(".start-chat-area").removeClass("d-none"),a(".active-chat").addClass("d-none"));const e=o.id;(()=>{const a=s.find("li.active").find(".user-chat-info").data("userid");o=contacts.find((s=>Number(s.id)===Number(a)))})(),o.id!==e&&(r(),p())}));var v=a(".user-chats");a(".chat-users-list-wrapper li").on("click",(function(){v.animate({scrollTop:v[0].scrollHeight},400)})),a(".chat-application .favorite i").on("click",(function(s){a(this).parent(".favorite").toggleClass("warning"),s.stopPropagation()})),a(".chat-application .menu-toggle").on("click",(function(s){a(".app-content .sidebar-left").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show")})),a(window).width()<992&&a(".chat-application .sidebar-toggle").on("click",(function(){a(".app-content .sidebar-content").addClass("show"),a(".chat-application .chat-overlay").addClass("show")})),a(window).width()>992&&a(".chat-application .chat-overlay").hasClass("show")&&a(".chat-application .chat-overlay").removeClass("show"),a(".chat-application #chat-search").on("keyup",(function(){var s=a(this).val().toLowerCase();""!=s?a(".chat-user-list .chat-users-list-wrapper li").filter((function(){a(this).toggle(a(this).text().toLowerCase().indexOf(s)>-1)})):a(".chat-user-list .chat-users-list-wrapper li").show()}));let m={};a(".chat-app-input").submit((()=>{const s=a(".message").val();if(console.log(s),""!==s){let e=`<div class="chat-content"><p>${s}<span class="block text-right line-height-1"><sub>${moment().format("h:mm A")}</sub></span></p></div>`;const t=a(".chat:last-child");0===t.length||t.hasClass("chat-left")?(e=`<div class="chat"><div class="chat-body">${e}</div></div>`,a(".chats").append(e)):t.find(".chat-body").append(e),a(".message").val(""),a(".user-chats").scrollTop(a(".user-chats > .chats").height()),m={driver_id:o.id,message:s},a.ajax({url:"/chat/sendMessage",type:"POST",data:m,success:a=>{a.success&&(m={},o.messages.history.push(a.message))},error:()=>{}})}})),window.Echo.private("chat").listen("NewChatMessage",(s=>{const e=s.message;if(o.messages&&o.messages.history.push(e),o.id===e.driver_id)h([e]);else{const s=a(`.user-chat-info[data-userid="${e.driver_id}"]`),t=s.find(".truncate"),i=s.find(".contact-meta"),o=i.find(".badge");t.text(e.content.substring(0,100)),o.length>0?o.text(Number(o.text())+1):i.append('<span class="badge badge-primary badge-pill float-right">1</span>')}}))}(jQuery),$(window).on("resize",(function(){$(window).width()>992&&$(".chat-application .chat-overlay").hasClass("show")&&($(".app-content .sidebar-left").removeClass("show"),$(".chat-application .chat-overlay").removeClass("show")),$(window).width()<992&&($(".chat-application .chat-profile-sidebar").hasClass("show")&&$(".chat-profile-sidebar").removeClass("show"),$(".chat-application .sidebar-toggle").on("click",(function(){$(".app-content .sidebar-content").addClass("show"),$(".chat-application .chat-overlay").addClass("show")})))}));

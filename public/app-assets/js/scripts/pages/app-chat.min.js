!function(a){"use strict";const e=a("#users-list"),s=a("#chats-list"),t=a("#contacts-list"),i=a("#multi_contacts"),o=a("#multi_messages");i.select2({placeholder:"Select"});const r=a=>{const e=moment().startOf("day"),s=moment().subtract(1,"days");let t="";return t=a.isSame(e,"d")?"Today":a.isSame(s,"d")?"Yesterday":a.format("M/D/YYYY"),t};contacts&&contacts.forEach((a=>{const e=a.latest_message?r(moment(a.latest_message.created_at)):"",o=`<li><div class="pr-1"><i></i></span></div><div class="user-chat-info" data-userid="${a.id}"><div class="contact-info"><h5 class="font-weight-bold mb-0">${a.name}</h5><p class="truncate">${a.latest_message?a.latest_message.content?a.latest_message.content:'<i class="fas fa-camera"></i> Photo':""}</p></div><div class="contact-meta"><span class="float-right mb-25">${e}</span>`+(a.unread_count?`<span class="badge badge-primary badge-pill float-right">${a.unread_count}</span>`:"")+"</div></div><i>";a.latest_message?s.append(o):t.append(o),i.append(`<option value="${a.id}">${a.name}</option>`)}));const c={};if(a.app.menu.is_touch_device())a(".chat-user-list").css("overflow","scroll"),a(".profile-sidebar-area .scroll-area").css("overflow","scroll"),a(".user-chats").css("overflow","scroll"),a(".user-profile-sidebar-area").css("overflow","scroll");else{if(a(".chat-application .chat-user-list").length>0)new PerfectScrollbar(".chat-user-list");if(a(".chat-application .profile-sidebar-area .scroll-area").length>0)new PerfectScrollbar(".profile-sidebar-area .scroll-area");if(a(".chat-application .user-chats").length>0){const a=document.querySelector(".user-chats");c.chat={container:a,scroll:new PerfectScrollbar(a,{wheelPropagation:!1})},a.addEventListener("ps-scroll-up",(e=>{a.scrollTop<=25&&u(!0)}))}if(a(".chat-application .user-profile-sidebar-area").length>0)new PerfectScrollbar(".user-profile-sidebar-area")}a(".chat-application .sidebar-profile-toggle").on("click",(function(){a(".chat-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-profile-toggle").on("click",(function(){a(".user-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-status input:radio[name=userStatus]").on("change",(function(){var e="avatar-status-"+this.value;a(".header-profile-sidebar .avatar span").removeClass(),a(".sidebar-profile-toggle .avatar span").removeClass(),a(".header-profile-sidebar .avatar span").addClass(e+" avatar-status-lg"),a(".sidebar-profile-toggle .avatar span").addClass(e)})),a(".chat-application .close-icon").on("click",(function(){a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show"),a(".sidebar-content").hasClass("show")||a(".chat-overlay").removeClass("show")})),a(".chat-application .sidebar-close-icon").on("click",(function(){a(".sidebar-content").removeClass("show"),a(".chat-overlay").removeClass("show")})),a(".chat-application .chat-overlay").on("click",(function(){a(".app-content .sidebar-content").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show"),a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show")}));let l={};const n=a(".user-chats .chats"),d=()=>{n.html("")};let h=null,p=null;const m=(e,s=!1)=>{const t=a=>{const e=r(a);return`<div class="divider" data-date="${a.format("YYYY/MM/DD")}"><div class="divider-text">${e}</div></div>`},i=a(".chats .divider:first-child"),o=a(c.chat.container).find(".chats"),l=o.height(),d=o.scrollTop();e.forEach(((r,m)=>{const g=moment(r.created_at);let u="";const v=`<span class="block text-right line-height-1"><sub>${moment(r.created_at).format("h:mm A")}</sub></span>`;if(r.content&&(u=`<p>${r.content}</p>`),r.image&&(u=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${r.image_url}" alt="image"></a>${u}</div>`),u=`<div class="chat-content" data-message="${r.id}">${u}${v}</div>`,s){if(i.length>0&&moment(i.data("date"),"YYYY/MM/DD").isSame(g,"date")&&i.remove(),p&&!p.isSame(g,"date")){const a=t(p);n.prepend(a)}p=g}else if(!h||!h.isSame(g,"date")){const a=t(g);n.append(a),h=g}const f=a(s?".chat:first-child":".chat:last-child");if(0===f.length||f.hasClass("chat-left")&&!r.is_driver_sender||!f.hasClass("chat-left")&&r.is_driver_sender?(u=`<div class="chat ${r.is_driver_sender?"chat-left":""}"><div class="chat-body">`+u+"</div></div>",s?n.prepend(u):n.append(u)):s?f.find(".chat-body").prepend(u):f.find(".chat-body").append(u),s&&e.length===m+1){const a=t(g);n.prepend(a),c.chat.container.scrollTop=d+o.height()-l,n.find(".more-data-spinner").remove()}})),c.chat.scroll.update(),s||(c.chat.container.scrollTop=o.height())};let g=!1;const u=(e=!1)=>{const s=!l.messages||l.messages.more,t=l.messages?l.messages.page:1,i=l.messages?l.messages.history:[];a(".chat_header").find("h6").text(l.name),(0===i.length||e)&&s?g||(g=!0,a.ajax({url:"/chat/getChatHistory",data:{driver_id:l.id,page:t,take:15},success:a=>{const s=[...a.results].reverse();l.messages={history:e?[...s,...i]:[...i,...s],more:a.pagination.more,page:t+1},m(e?a.results:s,e),a.pagination.more&&n.prepend('<div class="text-center more-data-spinner"><div class="spinner-border"></div></div>')}}).done((()=>{g=!1}))):e||(d(),m(l.messages.history))};a(".chat-application .chat-user-list ul li").on("click",(function(){a(".chat-user-list ul li").hasClass("active")&&a(".chat-user-list ul li").removeClass("active"),a(this).addClass("active"),a(this).find(".badge").remove(),a(".chat-user-list ul li").hasClass("active")?(a(".start-chat-area").addClass("d-none"),a(".active-chat").removeClass("d-none")):(a(".start-chat-area").removeClass("d-none"),a(".active-chat").addClass("d-none"));const s=l.id;(()=>{const a=e.find("li.active").find(".user-chat-info").data("userid");l=contacts.find((e=>Number(e.id)===Number(a)))})(),l.id!==s&&(d(),u())}));var v=a(".user-chats");a(".chat-users-list-wrapper li").on("click",(function(){v.animate({scrollTop:v[0].scrollHeight},400)})),a(".chat-application .favorite i").on("click",(function(e){a(this).parent(".favorite").toggleClass("warning"),e.stopPropagation()})),a(".chat-application .menu-toggle").on("click",(function(e){a(".app-content .sidebar-left").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show")})),a(window).width()<992&&a(".chat-application .sidebar-toggle").on("click",(function(){a(".app-content .sidebar-content").addClass("show"),a(".chat-application .chat-overlay").addClass("show")})),a(window).width()>992&&a(".chat-application .chat-overlay").hasClass("show")&&a(".chat-application .chat-overlay").removeClass("show"),a(".chat-application #chat-search").on("keyup",(function(){var e=a(this).val().toLowerCase();""!=e?a(".chat-user-list .chat-users-list-wrapper li").filter((function(){a(this).toggle(a(this).text().toLowerCase().indexOf(e)>-1)})):a(".chat-user-list .chat-users-list-wrapper li").show()}));let f=null;const b=(e=null,s=null)=>{const t=new FormData;e||s||(f&&(s=f),w.data&&(t.append("image",w.data),_()),e=[l.id]),t.append("message",s),e.forEach((a=>{t.append("drivers[]",a)}));const r=e.length>1;a.ajax({url:"/chat/sendMessage",type:"POST",data:t,contentType:!1,processData:!1,success:e=>{e.success&&(r?(e.messages.forEach((a=>{k(Number(a.driver_id),a,"sent")})),a("#multiMessage").modal("hide"),i.val("").trigger("change"),o.val("")):(f=null,l.messages.history.push(e.messages[0])))},error:()=>{throwErrorMsg()}}).always((()=>{r&&a("#multi-chat-form").find("button").html("Submit").prop("disabled",!1)}))};let w={};const C=a("#imageToSend"),y=C.find(".close-btn"),$=C.find(".content-body"),_=()=>{C.removeClass("open"),w={},setTimeout((()=>{$.html("")}),300)};y.click((()=>{_()})),window.addEventListener("keydown",(a=>{"Escape"===a.key&&C.hasClass("open")&&_()}));const k=(e,s,t)=>{const i=()=>{const i=a(`.user-chat-info[data-userid="${e}"]`);if(i.find(".truncate").text(s.content.substring(0,100)),"received"===t){const a=i.find(".contact-meta"),e=a.find(".badge");e.length>0?e.text(Number(e.text())+1):a.append('<span class="badge badge-primary badge-pill float-right">1</span>')}};if(l.id===e)m([s]),i();else{const a=contacts.find((a=>Number(a.id)===Number(e)));a.messages&&a.messages.history.push(s),i()}};a(".chat-app-input").submit((()=>{const e=a(".message"),s=e.val();let t="";if(""!==s&&(t=`<p>${s}</p>`,e.val(""),f=s),w.reader&&(t=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${w.reader.result}" alt="image"></a>${t}`),""===t)return!1;t+=`<span class="block text-right line-height-1"><sub>${moment().format("h:mm A")}</sub></span>`,(e=>{e=`<div class="chat-content">${e}</div>`;const s=a(".chat:last-child");0===s.length||s.hasClass("chat-left")?(e=`<div class="chat"><div class="chat-body">${e}</div></div>`,a(".chats").append(e)):s.find(".chat-body").append(e)})(t),a(".user-chats").scrollTop(a(".user-chats > .chats").height()),b()})),a("#multi-chat-form").submit((a=>{a.preventDefault();const e=o.val(),s=i.val();b(s,e)})),a("#appendImage").change((e=>{const s=a(e.currentTarget);if(""!==s.val()){const a=s.prop("files")[0],e=new FileReader;e.readAsDataURL(a),e.onload=()=>{$.html(`<img class="img-fluid mx-auto" src="${e.result}" alt="image"></a>`),$.removeClass("d-none"),C.addClass("open")},w={reader:e,data:a},s.val("")}})),a("#imagePreview").on("show.bs.modal",(e=>{const s=a(e.currentTarget),t=s.find(".modal-body").find(".modal-spinner"),i=s.find(".content-body"),o=a(e.relatedTarget),r=o.closest(".chat-content").data("message"),c=o.find("img");if(r){const e=l.messages.history.find((a=>Number(a.id)===Number(r)));a.ajax({url:"/s3storage/getTemporaryUrl",type:"GET",data:{url:e.image},success:a=>{i.html(`<img src="${a}" alt="image" class="img-fluid">`),t.addClass("d-none"),i.removeClass("d-none")},error:()=>{throwErrorMsg()}})}else i.html(`<img src="${c.attr("src")}" alt="image" class="img-fluid">`),t.addClass("d-none"),i.removeClass("d-none")})).on("hidden.bs.modal",(e=>{const s=a(e.currentTarget),t=s.find(".modal-body").find(".modal-spinner"),i=s.find(".content-body");i.html(""),t.removeClass("d-none"),i.addClass("d-none")})),window.Echo.private("chat").listen("NewChatMessage",(a=>{const e=a.message;e.newly_received=!0,k(Number(e.driver_id),e,"received")}))}(jQuery),$(window).on("resize",(function(){$(window).width()>992&&$(".chat-application .chat-overlay").hasClass("show")&&($(".app-content .sidebar-left").removeClass("show"),$(".chat-application .chat-overlay").removeClass("show")),$(window).width()<992&&($(".chat-application .chat-profile-sidebar").hasClass("show")&&$(".chat-profile-sidebar").removeClass("show"),$(".chat-application .sidebar-toggle").on("click",(function(){$(".app-content .sidebar-content").addClass("show"),$(".chat-application .chat-overlay").addClass("show")})))}));

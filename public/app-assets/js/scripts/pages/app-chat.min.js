!function(a){"use strict";const e=a("#users-list"),s=a("#chats-list"),t=a("#contacts-list"),i=a("#multi_contacts"),o=a("#multi_messages");i.select2({placeholder:"Select"}),contacts&&contacts.forEach((a=>{const e=a.latest_message?moment(a.latest_message.created_at).format("h:mm A"):"",o=`<li><div class="pr-1"><i></i></span></div><div class="user-chat-info" data-userid="${a.id}"><div class="contact-info"><h5 class="font-weight-bold mb-0">${a.name}</h5><p class="truncate">${a.latest_message?a.latest_message.content?a.latest_message.content:'<i class="fas fa-camera"></i> Photo':""}</p></div><div class="contact-meta"><span class="float-right mb-25">${e}</span>`+(a.unread_count?`<span class="badge badge-primary badge-pill float-right">${a.unread_count}</span>`:"")+"</div></div><i>";a.latest_message?s.append(o):t.append(o),i.append(`<option value="${a.id}">${a.name}</option>`)}));const r={};if(a.app.menu.is_touch_device())a(".chat-user-list").css("overflow","scroll"),a(".profile-sidebar-area .scroll-area").css("overflow","scroll"),a(".user-chats").css("overflow","scroll"),a(".user-profile-sidebar-area").css("overflow","scroll");else{if(a(".chat-application .chat-user-list").length>0)new PerfectScrollbar(".chat-user-list");if(a(".chat-application .profile-sidebar-area .scroll-area").length>0)new PerfectScrollbar(".profile-sidebar-area .scroll-area");if(a(".chat-application .user-chats").length>0){const a=document.querySelector(".user-chats");r.chat={container:a,scroll:new PerfectScrollbar(a,{wheelPropagation:!1})},a.addEventListener("ps-scroll-up",(e=>{a.scrollTop<=25&&g(!0)}))}if(a(".chat-application .user-profile-sidebar-area").length>0)new PerfectScrollbar(".user-profile-sidebar-area")}a(".chat-application .sidebar-profile-toggle").on("click",(function(){a(".chat-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-profile-toggle").on("click",(function(){a(".user-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-status input:radio[name=userStatus]").on("change",(function(){var e="avatar-status-"+this.value;a(".header-profile-sidebar .avatar span").removeClass(),a(".sidebar-profile-toggle .avatar span").removeClass(),a(".header-profile-sidebar .avatar span").addClass(e+" avatar-status-lg"),a(".sidebar-profile-toggle .avatar span").addClass(e)})),a(".chat-application .close-icon").on("click",(function(){a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show"),a(".sidebar-content").hasClass("show")||a(".chat-overlay").removeClass("show")})),a(".chat-application .sidebar-close-icon").on("click",(function(){a(".sidebar-content").removeClass("show"),a(".chat-overlay").removeClass("show")})),a(".chat-application .chat-overlay").on("click",(function(){a(".app-content .sidebar-content").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show"),a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show")}));let c={};const l=a(".user-chats .chats"),n=()=>{l.html("")};let d=null,h=null;const p=(e,s=!1)=>{const t=moment().startOf("day"),i=moment().subtract(1,"days"),o=a=>{let e="";return e=a.isSame(t,"d")?"Today":a.isSame(i,"d")?"Yesterday":a.format("M/D/YYYY"),`<div class="divider" data-date="${a.format("YYYY/MM/DD")}"><div class="divider-text">${e}</div></div>`},c=a(".chats .divider:first-child"),n=a(r.chat.container).find(".chats"),p=n.height(),m=n.scrollTop();e.forEach(((t,i)=>{const g=moment(t.created_at);let u="";const v=`<span class="block text-right line-height-1"><sub>${moment(t.created_at).format("h:mm A")}</sub></span>`;if(t.content&&(u=`<p>${t.content}</p>`),t.image&&(u=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${t.image_url}" alt="image"></a>${u}</div>`),u=`<div class="chat-content" data-message="${t.id}">${u}${v}</div>`,s){if(c.length>0&&moment(c.data("date"),"YYYY/MM/DD").isSame(g,"date")&&c.remove(),h&&!h.isSame(g,"date")){const a=o(h);l.prepend(a)}h=g}else if(!d||!d.isSame(g,"date")){const a=o(g);l.append(a),d=g}const f=a(s?".chat:first-child":".chat:last-child");if(0===f.length||f.hasClass("chat-left")&&!t.is_driver_sender||!f.hasClass("chat-left")&&t.is_driver_sender?(u=`<div class="chat ${t.is_driver_sender?"chat-left":""}"><div class="chat-body">`+u+"</div></div>",s?l.prepend(u):l.append(u)):s?f.find(".chat-body").prepend(u):f.find(".chat-body").append(u),s&&e.length===i+1){const a=o(g);l.prepend(a),r.chat.container.scrollTop=m+n.height()-p,l.find(".more-data-spinner").remove()}})),r.chat.scroll.update(),s||(r.chat.container.scrollTop=n.height())};let m=!1;const g=(e=!1)=>{const s=!c.messages||c.messages.more,t=c.messages?c.messages.page:1,i=c.messages?c.messages.history:[];a(".chat_header").find("h6").text(c.name),(0===i.length||e)&&s?m||(m=!0,a.ajax({url:"/chat/getChatHistory",data:{driver_id:c.id,page:t,take:15},success:a=>{const s=[...a.results].reverse();c.messages={history:e?[...s,...i]:[...i,...s],more:a.pagination.more,page:t+1},p(e?a.results:s,e),a.pagination.more&&l.prepend('<div class="text-center more-data-spinner"><div class="spinner-border"></div></div>')}}).done((()=>{m=!1}))):e||(n(),p(c.messages.history))};a(".chat-application .chat-user-list ul li").on("click",(function(){a(".chat-user-list ul li").hasClass("active")&&a(".chat-user-list ul li").removeClass("active"),a(this).addClass("active"),a(this).find(".badge").remove(),a(".chat-user-list ul li").hasClass("active")?(a(".start-chat-area").addClass("d-none"),a(".active-chat").removeClass("d-none")):(a(".start-chat-area").removeClass("d-none"),a(".active-chat").addClass("d-none"));const s=c.id;(()=>{const a=e.find("li.active").find(".user-chat-info").data("userid");c=contacts.find((e=>Number(e.id)===Number(a)))})(),c.id!==s&&(n(),g())}));var u=a(".user-chats");a(".chat-users-list-wrapper li").on("click",(function(){u.animate({scrollTop:u[0].scrollHeight},400)})),a(".chat-application .favorite i").on("click",(function(e){a(this).parent(".favorite").toggleClass("warning"),e.stopPropagation()})),a(".chat-application .menu-toggle").on("click",(function(e){a(".app-content .sidebar-left").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show")})),a(window).width()<992&&a(".chat-application .sidebar-toggle").on("click",(function(){a(".app-content .sidebar-content").addClass("show"),a(".chat-application .chat-overlay").addClass("show")})),a(window).width()>992&&a(".chat-application .chat-overlay").hasClass("show")&&a(".chat-application .chat-overlay").removeClass("show"),a(".chat-application #chat-search").on("keyup",(function(){var e=a(this).val().toLowerCase();""!=e?a(".chat-user-list .chat-users-list-wrapper li").filter((function(){a(this).toggle(a(this).text().toLowerCase().indexOf(e)>-1)})):a(".chat-user-list .chat-users-list-wrapper li").show()}));let v=null;const f=(e=null,s=null)=>{const t=new FormData;e||s||(v&&(s=v),b.data&&(t.append("image",b.data),$()),e=[c.id]),t.append("message",s),e.forEach((a=>{t.append("drivers[]",a)}));const r=e.length>1;a.ajax({url:"/chat/sendMessage",type:"POST",data:t,contentType:!1,processData:!1,success:e=>{e.success&&(r?(e.messages.forEach((a=>{_(Number(a.driver_id),a,"sent")})),a("#multiMessage").modal("hide"),i.val("").trigger("change"),o.val("")):(v=null,c.messages.history.push(e.messages[0])))},error:()=>{throwErrorMsg()}}).always((()=>{r&&a("#multi-chat-form").find("button").html("Submit").prop("disabled",!1)}))};let b={};const w=a("#imageToSend"),C=w.find(".close-btn"),y=w.find(".content-body"),$=()=>{w.removeClass("open"),b={},setTimeout((()=>{y.html("")}),300)};C.click((()=>{$()})),window.addEventListener("keydown",(a=>{"Escape"===a.key&&w.hasClass("open")&&$()}));const _=(e,s,t)=>{const i=()=>{const i=a(`.user-chat-info[data-userid="${e}"]`);if(i.find(".truncate").text(s.content.substring(0,100)),"received"===t){const a=i.find(".contact-meta"),e=a.find(".badge");e.length>0?e.text(Number(e.text())+1):a.append('<span class="badge badge-primary badge-pill float-right">1</span>')}};if(c.id===e)p([s]),i();else{const a=contacts.find((a=>Number(a.id)===Number(e)));a.messages&&a.messages.history.push(s),i()}};a(".chat-app-input").submit((()=>{const e=a(".message"),s=e.val();let t="";if(""!==s&&(t=`<p>${s}</p>`,e.val(""),v=s),b.reader&&(t=`<div class="chat-image"><a href="#imagePreview" data-toggle="modal" data-target="#imagePreview"><img class="img-fluid" src="${b.reader.result}" alt="image"></a>${t}`),""===t)return!1;t+=`<span class="block text-right line-height-1"><sub>${moment().format("h:mm A")}</sub></span>`,(e=>{e=`<div class="chat-content">${e}</div>`;const s=a(".chat:last-child");0===s.length||s.hasClass("chat-left")?(e=`<div class="chat"><div class="chat-body">${e}</div></div>`,a(".chats").append(e)):s.find(".chat-body").append(e)})(t),a(".user-chats").scrollTop(a(".user-chats > .chats").height()),f()})),a("#multi-chat-form").submit((a=>{a.preventDefault();const e=o.val(),s=i.val();f(s,e)})),a("#appendImage").change((e=>{const s=a(e.currentTarget);if(""!==s.val()){const a=s.prop("files")[0],e=new FileReader;e.readAsDataURL(a),e.onload=()=>{y.html(`<img class="img-fluid mx-auto" src="${e.result}" alt="image"></a>`),y.removeClass("d-none"),w.addClass("open")},b={reader:e,data:a},s.val("")}})),a("#imagePreview").on("show.bs.modal",(e=>{const s=a(e.currentTarget),t=s.find(".modal-body").find(".modal-spinner"),i=s.find(".content-body"),o=a(e.relatedTarget),r=o.closest(".chat-content").data("message"),l=o.find("img");if(r){const e=c.messages.history.find((a=>Number(a.id)===Number(r)));a.ajax({url:"/s3storage/getTemporaryUrl",type:"GET",data:{url:e.image},success:a=>{i.html(`<img src="${a}" alt="image" class="img-fluid">`),t.addClass("d-none"),i.removeClass("d-none")},error:()=>{throwErrorMsg()}})}else i.html(`<img src="${l.attr("src")}" alt="image" class="img-fluid">`),t.addClass("d-none"),i.removeClass("d-none")})).on("hidden.bs.modal",(e=>{const s=a(e.currentTarget),t=s.find(".modal-body").find(".modal-spinner"),i=s.find(".content-body");i.html(""),t.removeClass("d-none"),i.addClass("d-none")})),window.Echo.private("chat").listen("NewChatMessage",(a=>{const e=a.message;e.newly_received=!0,_(Number(e.driver_id),e,"received")}))}(jQuery),$(window).on("resize",(function(){$(window).width()>992&&$(".chat-application .chat-overlay").hasClass("show")&&($(".app-content .sidebar-left").removeClass("show"),$(".chat-application .chat-overlay").removeClass("show")),$(window).width()<992&&($(".chat-application .chat-profile-sidebar").hasClass("show")&&$(".chat-profile-sidebar").removeClass("show"),$(".chat-application .sidebar-toggle").on("click",(function(){$(".app-content .sidebar-content").addClass("show"),$(".chat-application .chat-overlay").addClass("show")})))}));

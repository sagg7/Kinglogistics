!function(a){"use strict";const e=a("#users-list"),s=a("#chats-list"),t=a("#contacts-list");contacts&&contacts.forEach((a=>{const e=a.latest_message?a.latest_message.is_driver_sender?moment.utc(a.latest_message.created_at).format("h:mm A"):moment(a.latest_message.created_at).format("h:mm A"):"",i=`<li><div class="pr-1"><i></i></span></div><div class="user-chat-info" data-userid="${a.id}"><div class="contact-info"><h5 class="font-weight-bold mb-0">${a.name}</h5><p class="truncate">${a.latest_message?a.latest_message.content:""}</p></div><div class="contact-meta"><span class="float-right mb-25">${e}</span>`+(a.unread_count?`<span class="badge badge-primary badge-pill float-right">${a.unread_count}</span>`:"")+"</div></div><i>";a.latest_message?s.append(i):t.append(i)}));const i={};if(a.app.menu.is_touch_device())a(".chat-user-list").css("overflow","scroll"),a(".profile-sidebar-area .scroll-area").css("overflow","scroll"),a(".user-chats").css("overflow","scroll"),a(".user-profile-sidebar-area").css("overflow","scroll");else{if(a(".chat-application .chat-user-list").length>0)new PerfectScrollbar(".chat-user-list");if(a(".chat-application .profile-sidebar-area .scroll-area").length>0)new PerfectScrollbar(".profile-sidebar-area .scroll-area");if(a(".chat-application .user-chats").length>0){const a=document.querySelector(".user-chats");i.chat={container:a,scroll:new PerfectScrollbar(a,{wheelPropagation:!1})},a.addEventListener("ps-scroll-up",(e=>{a.scrollTop<=25&&p(!0)}))}if(a(".chat-application .user-profile-sidebar-area").length>0)new PerfectScrollbar(".user-profile-sidebar-area")}a(".chat-application .sidebar-profile-toggle").on("click",(function(){a(".chat-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-profile-toggle").on("click",(function(){a(".user-profile-sidebar").addClass("show"),a(".chat-overlay").addClass("show")})),a(".chat-application .user-status input:radio[name=userStatus]").on("change",(function(){var e="avatar-status-"+this.value;a(".header-profile-sidebar .avatar span").removeClass(),a(".sidebar-profile-toggle .avatar span").removeClass(),a(".header-profile-sidebar .avatar span").addClass(e+" avatar-status-lg"),a(".sidebar-profile-toggle .avatar span").addClass(e)})),a(".chat-application .close-icon").on("click",(function(){a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show"),a(".sidebar-content").hasClass("show")||a(".chat-overlay").removeClass("show")})),a(".chat-application .sidebar-close-icon").on("click",(function(){a(".sidebar-content").removeClass("show"),a(".chat-overlay").removeClass("show")})),a(".chat-application .chat-overlay").on("click",(function(){a(".app-content .sidebar-content").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show"),a(".chat-profile-sidebar").removeClass("show"),a(".user-profile-sidebar").removeClass("show")}));let c={};const o=a(".user-chats .chats"),r=()=>{o.html("")};let l=null,n=null;const d=(e,s=!1)=>{const t=moment().startOf("day"),c=moment().subtract(1,"days"),r=a=>{let e="";return e=a.isSame(t,"d")?"Today":a.isSame(c,"d")?"Yesterday":a.format("M/D/YYYY"),`<div class="divider" data-date="${a.format("YYYY/MM/DD")}"><div class="divider-text">${e}</div></div>`},d=a(".chats .divider:first-child"),h=a(i.chat.container).find(".chats"),p=h.height(),m=h.scrollTop();e.forEach(((t,c)=>{const v=t.is_driver_sender&&!t.newly_received?moment.utc(t.created_at):moment(t.created_at),u=t.is_driver_sender&&!t.newly_received?moment.utc(t.created_at).format("h:mm A"):moment(t.created_at).format("h:mm A");let f=`<div class="chat-content"><p>${t.content}<span class="block text-right line-height-1"><sub>${u}</sub></span></p></div>`;const g=a(s?".chat:first-child":".chat:last-child");if(s){if(d.length>0&&moment(d.data("date"),"YYYY/MM/DD").isSame(v,"date")&&d.remove(),n&&!n.isSame(v,"date")){const a=r(n);o.prepend(a)}n=v}else if(!l||!l.isSame(v,"date")){const a=r(v);o.append(a),l=v}if(0===g.length||g.hasClass("chat-left")&&!t.is_driver_sender||!g.hasClass("chat-left")&&t.is_driver_sender?(f=`<div class="chat ${t.is_driver_sender?"chat-left":""}"><div class="chat-body">`+f+"</div></div>",s?o.prepend(f):o.append(f)):s?g.find(".chat-body").prepend(f):g.find(".chat-body").append(f),s&&e.length===c+1){const a=r(v);o.prepend(a),i.chat.container.scrollTop=m+h.height()-p,o.find(".more-data-spinner").remove()}})),i.chat.scroll.update(),s||(i.chat.container.scrollTop=h.height())};let h=!1;const p=(e=!1)=>{const s=!c.messages||c.messages.more,t=c.messages?c.messages.page:1,i=c.messages?c.messages.history:[];a(".chat_header").find("h6").text(c.name),(0===i.length||e)&&s?h||(h=!0,a.ajax({url:"/chat/getChatHistory",data:{driver_id:c.id,page:t,take:15},success:a=>{const s=[...a.results].reverse();c.messages={history:e?[...s,...i]:[...i,...s],more:a.pagination.more,page:t+1},d(e?a.results:s,e),console.log("here"),a.pagination.more&&o.prepend('<div class="text-center more-data-spinner"><div class="spinner-border"></div></div>')}}).done((()=>{h=!1}))):e||(r(),d(c.messages.history))};a(".chat-application .chat-user-list ul li").on("click",(function(){a(".chat-user-list ul li").hasClass("active")&&a(".chat-user-list ul li").removeClass("active"),a(this).addClass("active"),a(this).find(".badge").remove(),a(".chat-user-list ul li").hasClass("active")?(a(".start-chat-area").addClass("d-none"),a(".active-chat").removeClass("d-none")):(a(".start-chat-area").removeClass("d-none"),a(".active-chat").addClass("d-none"));const s=c.id;(()=>{const a=e.find("li.active").find(".user-chat-info").data("userid");c=contacts.find((e=>Number(e.id)===Number(a)))})(),c.id!==s&&(r(),p())}));var m=a(".user-chats");a(".chat-users-list-wrapper li").on("click",(function(){m.animate({scrollTop:m[0].scrollHeight},400)})),a(".chat-application .favorite i").on("click",(function(e){a(this).parent(".favorite").toggleClass("warning"),e.stopPropagation()})),a(".chat-application .menu-toggle").on("click",(function(e){a(".app-content .sidebar-left").removeClass("show"),a(".chat-application .chat-overlay").removeClass("show")})),a(window).width()<992&&a(".chat-application .sidebar-toggle").on("click",(function(){a(".app-content .sidebar-content").addClass("show"),a(".chat-application .chat-overlay").addClass("show")})),a(window).width()>992&&a(".chat-application .chat-overlay").hasClass("show")&&a(".chat-application .chat-overlay").removeClass("show"),a(".chat-application #chat-search").on("keyup",(function(){var e=a(this).val().toLowerCase();""!=e?a(".chat-user-list .chat-users-list-wrapper li").filter((function(){a(this).toggle(a(this).text().toLowerCase().indexOf(e)>-1)})):a(".chat-user-list .chat-users-list-wrapper li").show()}));let v={};a(".chat-app-input").submit((()=>{const e=a(".message").val();if(""!==e){let s=`<div class="chat-content"><p>${e}<span class="block text-right line-height-1"><sub>${moment().format("h:mm A")}</sub></span></p></div>`;const t=a(".chat:last-child");0===t.length||t.hasClass("chat-left")?(s=`<div class="chat"><div class="chat-body">${s}</div></div>`,a(".chats").append(s)):t.find(".chat-body").append(s),a(".message").val(""),a(".user-chats").scrollTop(a(".user-chats > .chats").height()),v={driver_id:c.id,message:e},a.ajax({url:"/chat/sendMessage",type:"POST",data:v,success:a=>{a.success&&(v={},c.messages.history.push(a.message))},error:()=>{}})}})),window.Echo.private("chat").listen("NewChatMessage",(e=>{const s=e.message;if(s.newly_received=!0,c.id===s.driver_id)d([s]);else{const e=contacts.find((a=>Number(a.id)===Number(s.driver_id)));e.messages&&e.messages.history.push(s);const t=a(`.user-chat-info[data-userid="${s.driver_id}"]`),i=t.find(".truncate"),c=t.find(".contact-meta"),o=c.find(".badge");i.text(s.content.substring(0,100)),o.length>0?o.text(Number(o.text())+1):c.append('<span class="badge badge-primary badge-pill float-right">1</span>')}}))}(jQuery),$(window).on("resize",(function(){$(window).width()>992&&$(".chat-application .chat-overlay").hasClass("show")&&($(".app-content .sidebar-left").removeClass("show"),$(".chat-application .chat-overlay").removeClass("show")),$(window).width()<992&&($(".chat-application .chat-profile-sidebar").hasClass("show")&&$(".chat-profile-sidebar").removeClass("show"),$(".chat-application .sidebar-toggle").on("click",(function(){$(".app-content .sidebar-content").addClass("show"),$(".chat-application .chat-overlay").addClass("show")})))}));
